<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á€á€®á€á€„á€ºá€¸á€€á€»á€½á€á€º á€™á€¯á€”á€·á€ºá€–á€­á€¯á€¸á€á€±á€…á€”á€…á€º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Padauk:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Firebase & Tone.js SDKs -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.9.15/build/Tone.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, getDoc, setDoc, onSnapshot, setLogLevel };
    </script>
    
    <!-- Chosen Palette: Dynamic based on theme (Festive, Modern, Minimal) -->
    <!-- Application Structure Plan: Three main views controlled by JS state: 1. Admin Panel (Secured Login/Config/Results Table). 2. Loading/Setup Screen. 3. Public Game View (Member Selection / Wheel Spin). Added dynamic app title configuration for generalization. Changed the result message to a Burmese blessing. Implemented sound effects via Tone.js and dynamic theming via JS. PNG download uses Canvas to render the result card. Prize amounts are auto-calculated randomly to ensure the total sum matches the budget, respecting min/max constraints and dynamic member/prize count. -->
    <!-- Visualization & Content Choices: Goal: Multi-user sequential spinning with hidden prize amounts, enhanced engagement, and customization. Viz/Presentation Method: Spin Wheel (CSS/JS animation) showing dynamic theme colors. Admin Results Table (HTML/Tailwind) showing all hidden data. Interaction: Sound effects for spin/result. Admin theme and title selection. PNG download of the result. Justification: Tone.js provides robust, single-file sound integration. Dynamic theme/title adds customization and reusability. Canvas rendering allows the user to save their personalized result card. Library/Method: Vanilla JavaScript + Firestore for state/logic, CSS animations for the wheel effect, Tailwind CSS for all styling, Tone.js for audio, Canvas for PNG download. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Padauk', sans-serif;
            background-color: #FDFBF6;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(1080deg); } 
        }
        .spinning {
            animation: spin 3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; 
        }
        .wheel-circle {
            transition: transform 3s ease-out;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }
        .wheel-circle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            box-shadow: 0 0 0 10px var(--wheel-border-color, #FBBF24); 
            border-radius: 50%;
        }
        .wheel-segment {
            position: absolute;
            top: 0;
            left: 50%;
            width: 50%;
            height: 50%;
            transform-origin: 0% 100%;
        }
        .wheel-pointer {
            position: absolute;
            top: -15px; 
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 20px solid var(--pointer-color, #D946EF); 
            z-index: 20;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto px-4 py-8 md:py-12 max-w-4xl">

        <header class="text-center mb-8">
            <h1 id="main-title" class="text-3xl md:text-4xl font-bold text-yellow-900">ğŸ® á€á€®á€á€„á€ºá€¸á€€á€»á€½á€á€º á€™á€¯á€”á€·á€ºá€–á€­á€¯á€¸á€á€±á€…á€”á€…á€º ğŸ®</h1>
            <p id="main-subtitle" class="text-gray-600 mt-2">Testing Team á€¡á€á€½á€€á€º á€á€…á€ºá€¦á€¸á€á€»á€„á€ºá€¸á€†á€¯á€™á€²á€…á€”á€…á€º</p>
        </header>

        <main class="bg-white/60 backdrop-blur-sm p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200 min-h-[500px] relative">
            
            <!-- Admin Controls Button -->
            <div class="mb-6 text-center">
                <button id="admin-login-btn" class="text-sm text-red-700 hover:text-red-900 font-semibold underline">
                    âš™ï¸ á€…á€®á€™á€¶á€á€”á€·á€ºá€á€½á€²á€™á€¾á€¯  á€á€„á€ºá€›á€±á€¬á€€á€ºá€›á€”á€º
                </button>
            </div>

            <!-- Loading/Error Screen -->
            <div id="loading-screen" class="absolute inset-0 bg-white/80 flex flex-col items-center justify-center p-4 z-50">
                <div id="loading-spinner" class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-700 mb-3"></div>
                <p id="loading-status" class="text-center text-gray-700 font-semibold">á€…á€”á€…á€ºá€…á€á€„á€ºá€”á€±á€•á€«á€á€Šá€º...</p>
            </div>

            <!-- Login Section -->
            <div id="login-section" class="mb-8 border border-red-300 p-4 rounded-xl bg-red-50 hidden">
                <h2 class="text-lg font-bold text-red-800 border-b pb-2 mb-4">á€…á€®á€™á€¶á€á€”á€·á€ºá€á€½á€²á€á€° á€á€„á€ºá€›á€±á€¬á€€á€ºá€á€¼á€„á€ºá€¸</h2>
                <form id="login-form" class="space-y-3">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700">á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€°á€¡á€™á€Šá€º (kmt)</label>
                        <input type="text" id="username" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">á€œá€»á€¾á€­á€¯á€·á€á€¾á€€á€ºá€”á€¶á€•á€«á€á€º</label>
                        <input type="password" id="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                    </div>
                    <button type="submit" class="w-full bg-red-600 text-white font-bold py-2 rounded-lg hover:bg-red-700 transition-colors">ğŸ” á€á€„á€ºá€›á€±á€¬á€€á€ºá€™á€Šá€º</button>
                    <p id="login-error" class="text-red-500 text-sm mt-2 text-center hidden">á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€°á€¡á€™á€Šá€º (á€á€­á€¯á€·) á€œá€»á€¾á€­á€¯á€·á€á€¾á€€á€ºá€”á€¶á€•á€«á€á€º á€™á€™á€¾á€”á€ºá€€á€”á€ºá€•á€«á‹</p>
                </form>
            </div>

            <!-- Admin Panel (Hidden until successful login) -->
            <div id="admin-panel" class="mb-8 relative border border-green-300 p-4 rounded-2xl bg-green-50 hidden">
                <h2 class="text-xl font-bold text-green-800 border-b pb-2 mb-4">âœ… á€…á€®á€™á€¶á€á€”á€·á€ºá€á€½á€²á€á€° Panel</h2>
                <button id="close-admin-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-xl font-bold p-1">Ã—</button>
                
                <p class="text-sm text-gray-600 mb-4">á€á€á€­á€•á€±á€¸á€á€»á€€á€º: á€¡á€±á€¬á€€á€ºá€•á€«á€á€”á€ºá€–á€­á€¯á€¸á€™á€»á€¬á€¸á€€á€­á€¯ á€•á€¼á€„á€ºá€†á€„á€ºá€•á€¼á€®á€¸á€•á€«á€€ **á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€›á€”á€º** á€á€œá€¯á€á€ºá€€á€­á€¯ á€”á€¾á€­á€•á€ºá€•á€«á‹</p>
                
                <form id="admin-form" class="space-y-4">
                    <h3 class="font-semibold text-lg text-green-700">á. á€¡á€á€¼á€±á€á€¶á€á€á€ºá€™á€¾á€á€ºá€á€»á€€á€ºá€™á€»á€¬á€¸</h3>
                    
                    <!-- New Title Input -->
                    <div class="col-span-2">
                        <label for="app-title-input" class="block text-sm font-medium text-gray-700">App á€á€±á€«á€„á€ºá€¸á€…á€¥â—Œá€º/á€¡á€–á€½á€²á€·á€¡á€™á€Šá€º</label>
                        <input type="text" id="app-title-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                    </div>
                    
                    <!-- Theme Selector -->
                    <div class="col-span-2">
                        <label for="app-theme-select" class="block text-sm font-medium text-gray-700">App Theme á€›á€½á€±á€¸á€á€»á€šá€ºá€›á€”á€º</label>
                        <select id="app-theme-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                            <!-- Options added by JS -->
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="total-amount" class="block text-sm font-medium text-gray-700">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸á€„á€½á€±á€•á€™á€¬á€ (MMK)</label>
                            <input type="number" id="total-amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="1000" required>
                        </div>
                        <div>
                            <label for="min-amount" class="block text-sm font-medium text-gray-700">á€á€…á€ºá€¦á€¸á€œá€»á€¾á€„á€º á€¡á€”á€Šá€ºá€¸á€†á€¯á€¶á€¸ (MMK)</label>
                            <input type="number" id="min-amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="100" required>
                        </div>
                        <div class="col-span-1">
                            <label for="max-amount" class="block text-sm font-medium text-gray-700">á€á€…á€ºá€¦á€¸á€œá€»á€¾á€„á€º á€¡á€™á€»á€¬á€¸á€†á€¯á€¶á€¸ (MMK)</label>
                            <input type="number" id="max-amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="100" required>
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700">á€œá€€á€ºá€›á€¾á€­á€¡á€–á€½á€²á€·á€á€„á€ºá€¦á€¸á€›á€±</label>
                            <p id="member-count" class="mt-1 text-2xl font-bold text-green-700 p-2">9</p>
                        </div>
                    </div>
                    <div>
                        <label for="team-members" class="block text-sm font-medium text-gray-700">á€¡á€–á€½á€²á€·á€á€„á€ºá€…á€¬á€›á€„á€ºá€¸ (á€á€…á€ºá€€á€¼á€±á€¬á€„á€ºá€¸á€…á€®á€á€½á€²á€›á€±á€¸á€•á€«)</label>
                        <textarea id="team-members" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required></textarea>
                    </div>

                    <!-- Dynamic Prize Management Section -->
                    <h3 class="font-semibold text-lg text-green-700 mt-6 flex justify-between items-center">
                        <span>á‚. á€†á€¯á€•á€™á€¬á€ á€á€á€ºá€™á€¾á€á€ºá€á€¼á€„á€ºá€¸ (<span id="prize-count-display">9</span> á€™á€»á€­á€¯á€¸)</span>
                        <div class="space-x-2">
                            <button type="button" id="add-prize-btn" class="text-xs bg-green-500 text-white p-1 rounded hover:bg-green-600 font-semibold">+ á€†á€¯á€‘á€Šá€·á€º</button>
                            <button type="button" id="remove-prize-btn" class="text-xs bg-red-500 text-white p-1 rounded hover:bg-red-600 font-semibold">- á€†á€¯á€–á€»á€€á€º</button>
                        </div>
                    </h3>
                    <div id="prize-setup-container" class="space-y-2">
                        <!-- Prize inputs generated by JS -->
                    </div>
                    <p id="prize-sum-status" class="text-sm mt-2 text-center font-semibold text-green-600 hidden"></p>
                    
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors">ğŸ’¾ á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸ á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€›á€”á€º</button>
                    <p id="admin-message" class="text-sm mt-2 text-center font-semibold text-green-600 hidden"></p>
                </form>

                <h3 class="text-xl font-bold text-green-800 mt-8 border-t pt-4">áƒ. á€œá€€á€ºá€›á€¾á€­ á€›á€œá€’á€ºá€™á€»á€¬á€¸ (á€œá€»á€¾á€­á€¯á€·á€á€¾á€€á€ºá€á€»á€€á€º)</h3>
                <p class="text-sm text-gray-600 mb-4">á€˜á€šá€ºá€á€°á€€ á€˜á€šá€ºá€¡á€›á€±á€¬á€„á€ºá€”á€²á€· á€˜á€šá€ºá€œá€±á€¬á€€á€ºá€›á€á€½á€¬á€¸á€œá€²á€†á€­á€¯á€á€¬ á€¡á€±á€¬á€€á€ºá€™á€¾á€¬ á€á€­á€¯á€€á€ºá€›á€­á€¯á€€á€ºá€•á€±á€«á€ºá€”á€±á€•á€«á€á€šá€ºá‹</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-green-100 text-sm font-medium text-green-800">
                                <th class="p-3 text-left">á€¡á€–á€½á€²á€·á€á€„á€ºá€¡á€™á€Šá€º</th>
                                <th class="p-3 text-center">á€¡á€á€¼á€±á€¡á€”á€±</th>
                                <th class="p-3 text-center">á€¡á€›á€±á€¬á€„á€º</th>
                                <th class="p-3 text-right">á€„á€½á€±á€•á€™á€¬á€ (MMK)</th>
                                <th class="p-3 text-center">Reset</th>
                            </tr>
                        </thead>
                        <tbody id="admin-results-table">
                            <!-- Real-time results populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Public Game View (Wheel & Selection) -->
            <div id="game-view" class="flex flex-col items-center justify-center p-6 md:p-8 hidden">
                <h3 class="text-lg font-bold text-yellow-800 mb-4">ğŸ‰ á€™á€¯á€”á€·á€ºá€–á€­á€¯á€¸á€œá€¾á€Šá€·á€ºá€›á€”á€º</h3>
                
                <!-- Member Selector -->
                <div class="w-full max-w-xs mb-6">
                    <label for="spinner-select" class="block text-sm font-medium text-gray-700 mb-2">á€á€„á€·á€ºá€¡á€™á€Šá€ºá€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«:</label>
                    <select id="spinner-select" class="block w-full rounded-md border-gray-300 shadow-sm p-2 bg-white text-lg font-semibold">
                        <option value="" disabled selected>--- á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€« ---</option>
                    </select>
                </div>
                
                <!-- Wheel Area -->
                <div class="relative w-64 h-64 mb-8">
                    <div id="wheel" class="wheel-circle w-full h-full border-4 relative">
                        <!-- Segments will be inserted here by JS -->
                    </div>
                    <div class="wheel-pointer"></div>
                </div>

                <button id="generate-btn" class="w-full max-w-xs font-bold py-4 px-4 rounded-full text-xl transition-all duration-300 shadow-lg hover:shadow-xl focus:outline-none focus:ring-4" disabled>
                    ğŸ’° á€œá€¾á€Šá€·á€ºá€™á€Šá€º
                </button>
                <p id="spin-status" class="mt-4 text-center text-sm text-gray-600 h-6"></p>

                <!-- Individual Result Display -->
                <div id="individual-result" class="mt-6 p-4 rounded-xl shadow-xl border-t-4 border-yellow-500 bg-yellow-50 w-full max-w-xs text-center hidden">
                    <div class="font-bold text-xl text-yellow-900 mb-2">á€›á€œá€’á€º</div>
                    <p class="text-gray-700">á€á€„á€ºá€›á€›á€¾á€­á€á€±á€¬á€†á€¯á€™á€¾á€¬:</p>
                    <div id="result-color-display" class="font-extrabold text-2xl mt-1 p-2 rounded-lg text-white shadow-md"></div>
                    <p id="result-wish" class="text-sm text-gray-500 mt-2">á€’á€®á€†á€¯á€•á€™á€¬á€á€œá€±á€¸á€€ á€á€„á€·á€ºá€¡á€á€½á€€á€º á€€á€¶á€€á€±á€¬á€„á€ºá€¸á€á€¼á€„á€ºá€¸á€á€½á€± á€šá€°á€†á€±á€¬á€„á€ºá€œá€¬á€•á€«á€…á€±á‹</p>
                    <button id="download-result-btn" class="mt-4 bg-emerald-500 text-white py-2 px-4 rounded-lg text-sm font-semibold hover:bg-emerald-600 transition-colors">
                        â¬‡ï¸ á€›á€œá€’á€ºá€•á€¯á€¶á€€á€­á€¯ Download á€†á€½á€²á€™á€Šá€º
                    </button>
                </div>

                <div id="reset-info" class="mt-6 p-4 bg-gray-100 rounded-lg text-sm text-gray-600 hidden w-full max-w-xs text-center">
                    á€‚á€­á€™á€ºá€¸á€¡á€á€…á€ºá€…á€á€„á€ºá€›á€”á€º Admin á€™á€¾á€á€¬ á€•á€¼á€”á€ºá€œá€Šá€ºá€á€á€ºá€™á€¾á€á€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹
                </div>
            </div>
            
        </main>

        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>&copy; 2025 | á€•á€»á€±á€¬á€ºá€›á€½á€¾á€„á€ºá€…á€›á€¬á€á€®á€á€„á€ºá€¸á€€á€»á€½á€á€ºá€–á€¼á€…á€ºá€•á€«á€…á€±á‹</p>
        </footer>

    </div>

    <script type="module">
        // --- Hardcoded Authentication Credentials ---
        const ADMIN_USERNAME = 'kmt';
        const ADMIN_PASSWORD = 'Thadingyut2025';
        
        // --- Firebase Globals & Setup ---
        const firebaseConfig = {
            apiKey: "AIzaSyCJ1ZtAu_S0VBZRtyIjuKHfBalHmaeu2aw",
            authDomain: "kmtechspaceship.firebaseapp.com",
            projectId: "kmtechspaceship",
            storageBucket: "kmtechspaceship.firebasestorage.app",
            messagingSenderId: "494150534835",
            appId: "1:494150534835:web:d2b654e04d7b52ca1912c6",
            measurementId: "G-CWJ6BXN5TY"
        };
        
        const appIdForPath = firebaseConfig.projectId; 
        const initialAuthToken = null; 

        let db, auth;
        let userId = null;
        let gameData = null;

        const GAME_DOC_PATH = `artifacts/${appIdForPath}/public/data/thadingyut_game/config`;


        // --- Theme Definitions ---
        const THEMES = {
            'festive': {
                name: 'ğŸ® á€á€®á€á€„á€ºá€¸á€€á€»á€½á€á€ºá€›á€½á€¾á€„á€ºá€œá€”á€ºá€¸',
                pointerColor: '#D946EF', // Purple
                borderColor: '#FBBF24', // Gold
                buttonClasses: 'bg-red-600 hover:bg-red-700 focus:ring-4 focus:ring-red-300',
            },
            'modern': {
                name: 'âœ¨ á€á€±á€á€ºá€™á€®á€¡á€±á€¸á€†á€±á€¸',
                pointerColor: '#3B82F6', // Blue
                borderColor: '#9CA3AF', // Gray
                buttonClasses: 'bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300',
            },
            'minimal': {
                name: 'âšª á€›á€­á€¯á€¸á€›á€¾á€„á€ºá€¸á€–á€¼á€°á€…á€„á€º',
                pointerColor: '#1F2937', // Dark Gray
                borderColor: '#000000', // Black
                buttonClasses: 'bg-gray-800 hover:bg-gray-700 focus:ring-4 focus:ring-gray-300',
            }
        };

        // --- Default Data ---
        const defaultData = {
            appTitle: 'Testing Team', // New default title
            totalAmount: 30000,
            minAmount: 3000,
            maxAmount: 7000,
            theme: 'festive',
            teamMembers: [
                "sis TTM", "sis TWN", "sis NHHM", "sis EMT", "bro YHA",
                "sis LLO", "sis PDL", "sis ZMO", "bro KMT"
            ].join('\n')
        };

        const DEFAULT_PRIZES = [
            { colorName: "á€›á€½á€¾á€±á€›á€±á€¬á€„á€º", hex: "#FFD700", allocated: false },
            { colorName: "á€•á€á€¹á€á€™á€¼á€¬á€¸á€”á€®", hex: "#D81B60", allocated: false },
            { colorName: "á€€á€¼á€±á€¸á€”á€®á€›á€±á€¬á€„á€º", hex: "#CD7F32", allocated: false },
            { colorName: "á€™á€¼á€›á€±á€¬á€„á€º", hex: "#00A86B", allocated: false },
            { colorName: "á€”á€®á€œá€¬á€•á€¼á€¬", hex: "#4169E1", allocated: false },
            { colorName: "á€„á€½á€±á€›á€±á€¬á€„á€º", hex: "#C0C0C0", allocated: false },
            { colorName: "á€œá€­á€™á€¹á€™á€±á€¬á€ºá€›á€±á€¬á€„á€º", hex: "#FF8C00", allocated: false },
            { colorName: "á€›á€½á€€á€ºá€…á€­á€™á€ºá€¸á€›á€±á€¬á€„á€º", hex: "#8FBC8F", allocated: false },
            { colorName: "á€á€›á€™á€ºá€¸á€›á€±á€¬á€„á€º", hex: "#8A2BE2", allocated: false },
        ];


        // --- DOM Elements ---
        const loadingScreenEl = document.getElementById('loading-screen');
        const loginSectionEl = document.getElementById('login-section');
        const adminPanelEl = document.getElementById('admin-panel');
        const gameViewEl = document.getElementById('game-view');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const closeAdminBtn = document.getElementById('close-admin-btn');
        const loginForm = document.getElementById('login-form');
        const adminForm = document.getElementById('admin-form');
        const loginErrorEl = document.getElementById('login-error');
        const adminMessageEl = document.getElementById('admin-message');
        const memberCountEl = document.getElementById('member-count');
        const prizeCountDisplayEl = document.getElementById('prize-count-display');
        const prizeSetupContainerEl = document.getElementById('prize-setup-container');
        const addPrizeBtn = document.getElementById('add-prize-btn');
        const removePrizeBtn = document.getElementById('remove-prize-btn');
        const prizeSumStatusEl = document.getElementById('prize-sum-status');
        const adminResultsTableEl = document.getElementById('admin-results-table');
        const spinnerSelectEl = document.getElementById('spinner-select');
        const wheelEl = document.getElementById('wheel');
        const generateBtn = document.getElementById('generate-btn');
        const spinStatusEl = document.getElementById('spin-status');
        const individualResultEl = document.getElementById('individual-result');
        const resultColorDisplayEl = document.getElementById('result-color-display');
        const downloadResultBtn = document.getElementById('download-result-btn');
        const resetInfoEl = document.getElementById('reset-info');
        const appThemeSelectEl = document.getElementById('app-theme-select');
        const mainTitleEl = document.getElementById('main-title');
        const mainSubtitleEl = document.getElementById('main-subtitle');
        const appTitleInputEl = document.getElementById('app-title-input');
        const resultWishEl = document.getElementById('result-wish'); // New DOM element

        // --- Tone.js Globals ---
        let spinnerSynth, resultSynth;
        let spinnerLoop;
        let audioContextStarted = false;

        // --- Core Functions ---

        async function initFirebase() {
            try {
                if (firebaseConfig && firebaseConfig.projectId) {
                    const app = firebase.initializeApp(firebaseConfig);
                    db = firebase.getFirestore(app);
                    auth = firebase.getAuth(app);
                    firebase.setLogLevel('error'); 

                    await firebase.signInAnonymously(auth); 
                    userId = auth.currentUser.uid;
                    
                    setupGameListener();
                    setupTone(); 

                } else {
                    console.error("Firebase configuration is missing or incomplete.");
                }
            } catch (e) {
                console.error("Firebase Initialization Error:", e);
                loadingScreenEl.classList.add('hidden');
                gameViewEl.classList.remove('hidden'); 
                spinStatusEl.textContent = `âŒ á€…á€”á€…á€ºá€á€»á€­á€á€ºá€†á€€á€ºá€™á€¾á€¯ á€¡á€™á€¾á€¬á€¸á‹ (${e.message || 'Error'})`;
            }
        }
        
        function setupTone() {
            if (typeof Tone === 'undefined') return;
            try {
                document.body.addEventListener('click', () => {
                    if (Tone.context.state !== 'running') {
                        Tone.start();
                        audioContextStarted = true;
                    }
                }, { once: true });
                
                spinnerSynth = new Tone.NoiseSynth({
                    noise: { type: "pink" },
                    envelope: { attack: 0.01, decay: 0.05, sustain: 1, release: 0.01 }
                }).toDestination();

                resultSynth = new Tone.Synth({
                    oscillator: { type: "triangle" },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.1, release: 1 }
                }).toDestination();
                
                spinnerLoop = new Tone.Loop(time => {
                    spinnerSynth.triggerAttackRelease("16n", time, 0.3); 
                }, "16n").start(0);
                Tone.Transport.stop(); 
                
            } catch(e) {
                console.warn("Tone.js setup failed:", e);
            }
        }

        function startSpinSound() {
            if (audioContextStarted && typeof Tone !== 'undefined') {
                Tone.Transport.start();
            }
        }

        function stopSpinSound() {
            if (typeof Tone !== 'undefined') {
                Tone.Transport.stop();
            }
        }

        function playResultSound() {
            if (audioContextStarted && typeof Tone !== 'undefined') {
                resultSynth.triggerAttackRelease("C5", "8n");
                resultSynth.triggerAttackRelease("G5", "8n", "+0.1");
            }
        }

        function setupGameListener() {
            const docRef = firebase.doc(db, GAME_DOC_PATH);

            firebase.onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    gameData = docSnap.data();
                    // Ensure new fields exist on old data
                    if (gameData.appTitle === undefined) gameData.appTitle = defaultData.appTitle;
                    if (gameData.theme === undefined) gameData.theme = defaultData.theme;
                    renderGameUI();
                } else {
                    initializeDefaultGame();
                }
            }, (error) => {
                console.error("Firestore Listener Error:", error);
            });
        }
        
        async function initializeDefaultGame() {
            const members = defaultData.teamMembers.split('\n').filter(n => n.trim() !== '');
            const initialMembers = members.map(name => ({
                name: name,
                spun: false,
                resultColor: null,
                resultAmount: null,
                spinnerId: null
            }));

            const initialPrizes = calculateRandomPrizes(DEFAULT_PRIZES.slice(0, members.length), defaultData.totalAmount, defaultData.minAmount, defaultData.maxAmount);

            const initialData = {
                appTitle: defaultData.appTitle,
                totalAmount: defaultData.totalAmount,
                minAmount: defaultData.minAmount,
                maxAmount: defaultData.maxAmount,
                theme: defaultData.theme,
                teamMembers: initialMembers,
                prizes: initialPrizes,
                lastUpdated: new Date().toISOString()
            };

            try {
                const docRef = firebase.doc(db, GAME_DOC_PATH);
                await firebase.setDoc(docRef, initialData);
            } catch (e) {
                console.error("Failed to initialize default game data:", e);
            }
        }

        function renderGameUI() {
            if (!gameData) return;
            
            updateHeaderAndWish(); // Update titles and the wish message
            applyTheme(gameData.theme);

            loadingScreenEl.classList.add('hidden');
            gameViewEl.classList.remove('hidden');

            renderWheel();
            renderSpinnerSelection();

            if (!adminPanelEl.classList.contains('hidden')) {
                updateAdminPanelForms();
                renderAdminResultsTable();
            }
        }
        
        function updateHeaderAndWish() {
            const title = gameData.appTitle || 'á€™á€¯á€”á€·á€ºá€–á€­á€¯á€¸á€á€±á€…á€”á€…á€º';
            mainTitleEl.innerHTML = `ğŸ® ${title} ğŸ®`;
            mainSubtitleEl.textContent = `á€¡á€–á€½á€²á€·á€â—Œá€„á€ºá€™á€»á€¬á€¸á€¡á€á€½á€€á€º á€á€…á€ºá€¦á€¸á€á€»á€„á€ºá€¸á€†á€¯á€™á€²á€…á€”á€…á€º`;
            resultWishEl.textContent = 'á€’á€®á€†á€¯á€•á€™á€¬á€á€œá€±á€¸á€€ á€á€„á€·á€ºá€¡á€á€½á€€á€º á€€á€¶á€€á€±á€¬á€„á€ºá€¸á€á€¼á€„á€ºá€¸á€á€½á€± á€šá€°á€†á€±á€¬á€„á€ºá€œá€¬á€•á€«á€…á€±á‹';
        }
        
        function applyTheme(themeName) {
            const theme = THEMES[themeName] || THEMES['festive'];
            const root = document.documentElement;
            
            root.style.setProperty('--pointer-color', theme.pointerColor);
            root.style.setProperty('--wheel-border-color', theme.borderColor);
            
            generateBtn.className = `w-full max-w-xs font-bold py-4 px-4 rounded-full text-xl transition-all duration-300 shadow-lg hover:shadow-xl focus:outline-none ${theme.buttonClasses}`;
            generateBtn.classList.add('text-white'); 
        
            wheelEl.style.borderColor = theme.borderColor;
        }

        function renderWheel() {
            const prizes = gameData.prizes.filter(p => !p.allocated);
            const numSegments = prizes.length;
            wheelEl.innerHTML = ''; 

            if (numSegments === 0) {
                 wheelEl.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-center text-red-600 font-bold p-4 bg-gray-200/90 rounded-full">á€†á€¯á€¡á€¬á€¸á€œá€¯á€¶á€¸ á€•á€¼á€®á€¸á€†á€¯á€¶á€¸á€á€½á€¬á€¸á€•á€«á€•á€¼á€®á‹</div>';
                 return;
            }

            const anglePerSegment = 360 / numSegments;

            prizes.forEach((prize, index) => {
                const segment = document.createElement('div');
                segment.className = 'wheel-segment';
                segment.style.backgroundColor = prize.hex;
                segment.style.transform = `rotate(${index * anglePerSegment}deg) skewY(-${90 - anglePerSegment}deg)`;
                
                const innerSegment = document.createElement('div');
                innerSegment.className = 'absolute top-0 left-0 w-full h-full';
                innerSegment.style.transform = `skewY(${90 - anglePerSegment}deg) rotate(0deg)`;
                innerSegment.style.paddingLeft = '50%';
                innerSegment.style.textAlign = 'center';
                innerSegment.style.fontSize = '12px';
                innerSegment.style.fontWeight = 'bold';
                innerSegment.style.color = getContrastColor(prize.hex);
                innerSegment.style.lineHeight = '64px';
                innerSegment.textContent = prize.colorName;

                segment.appendChild(innerSegment);
                wheelEl.appendChild(segment);
            });
        }
        
        function renderSpinnerSelection() {
            const members = gameData.teamMembers;
            spinnerSelectEl.innerHTML = '<option value="" disabled selected>--- á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€« ---</option>';
            generateBtn.disabled = true;
            individualResultEl.classList.add('hidden');
            downloadResultBtn.classList.add('hidden'); 
            resetInfoEl.classList.add('hidden');
            
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.name;
                option.textContent = member.name;
                if (member.spun) {
                    option.textContent += ' (á€œá€¾á€Šá€·á€ºá€•á€¼á€®á€¸)';
                    option.disabled = true;
                }
                spinnerSelectEl.appendChild(option);
            });
            
            if (members.every(m => m.spun)) {
                 spinStatusEl.textContent = "á€‚á€­á€™á€ºá€¸á€•á€¼á€®á€¸á€†á€¯á€¶á€¸á€•á€«á€•á€¼á€®á‹";
                 resetInfoEl.classList.remove('hidden');
            } else {
                 spinStatusEl.textContent = "á€œá€¾á€Šá€·á€ºá€™á€Šá€·á€ºá€á€°á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«á‹"; 
            }
            
            spinnerSelectEl.onchange = function() {
                const name = spinnerSelectEl.value;
                const selectedMember = members.find(m => m.name === name);

                if (selectedMember && !selectedMember.spun) {
                    generateBtn.disabled = false;
                    spinStatusEl.textContent = `${selectedMember.name} á€¡á€á€„á€·á€ºá€–á€¼á€…á€ºá€•á€«á€•á€¼á€®á‹`;
                    individualResultEl.classList.add('hidden');
                } else if (selectedMember && selectedMember.spun) {
                    generateBtn.disabled = true;
                    spinStatusEl.textContent = `âœ… ${selectedMember.name} á€á€Šá€º ${selectedMember.resultColor} á€†á€¯á€€á€­á€¯ á€›á€›á€¾á€­á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹`;
                    displayIndividualResult(selectedMember);
                } else {
                    generateBtn.disabled = true;
                    spinStatusEl.textContent = "á€œá€¾á€Šá€·á€ºá€™á€Šá€·á€ºá€á€°á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«á‹";
                }
            };
        }

        async function handleSpin() {
            const selectedName = spinnerSelectEl.value;
            if (!selectedName || generateBtn.disabled) return;
            
            const currentMemberIndex = gameData.teamMembers.findIndex(m => m.name === selectedName);
            const currentMember = gameData.teamMembers[currentMemberIndex];
            if (!currentMember || currentMember.spun) return;
            
            const availablePrizes = gameData.prizes.filter(p => !p.allocated);
            if (availablePrizes.length === 0) {
                spinStatusEl.textContent = "á€†á€¯á€™á€›á€¾á€­á€á€±á€¬á€·á€•á€«";
                generateBtn.disabled = true;
                return;
            }

            const prizeIndex = Math.floor(Math.random() * availablePrizes.length);
            const selectedPrize = availablePrizes[prizeIndex];
            
            const allPrizes = gameData.prizes.filter(p => !p.allocated);
            const targetPrizeIndex = allPrizes.findIndex(p => p.colorName === selectedPrize.colorName); 
            
            const numSegments = allPrizes.length; 
            const anglePerSegment = 360 / numSegments;
            
            const baseRotations = 360 * 10; 
            const targetAngle = targetPrizeIndex * anglePerSegment + (anglePerSegment / 2); 
            const offset = Math.random() * (anglePerSegment * 0.8) - (anglePerSegment * 0.4); 
            const finalRotation = baseRotations + targetAngle + offset;
            
            generateBtn.disabled = true;
            generateBtn.textContent = 'ğŸ”„ á€œá€¾á€Šá€·á€ºá€”á€±á€á€Šá€º...';
            spinStatusEl.textContent = "á€†á€¯á€™á€²á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€”á€±á€•á€«á€á€Šá€º...";
            wheelEl.style.transition = 'transform 3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            wheelEl.style.transform = `rotate(${finalRotation}deg)`;
            
            startSpinSound(); 

            setTimeout(async () => {
                stopSpinSound(); 
                playResultSound(); 

                spinStatusEl.textContent = "âœ… á€›á€œá€’á€ºá€‘á€½á€€á€ºá€•á€±á€«á€ºá€•á€«á€•á€¼á€®á‹";
                
                try {
                    const docRef = firebase.doc(db, GAME_DOC_PATH);
                    
                    const newMembers = gameData.teamMembers.map((m, i) => {
                        if (i === currentMemberIndex) {
                            return { 
                                ...m, 
                                spun: true, 
                                resultColor: selectedPrize.colorName, 
                                resultAmount: selectedPrize.amount,
                                spinnerId: userId
                            };
                        }
                        return m;
                    });
                    
                    const newPrizes = gameData.prizes.map(p => {
                        if (p.colorName === selectedPrize.colorName) {
                            return { ...p, allocated: true };
                        }
                        return p;
                    });

                    await firebase.setDoc(docRef, {
                        ...gameData, 
                        teamMembers: newMembers, 
                        prizes: newPrizes,
                        lastUpdated: new Date().toISOString()
                    });
                    
                    displayIndividualResult({ name: selectedName, resultColor: selectedPrize.colorName });

                } catch (error) {
                    console.error("Firestore Update Error:", error);
                    spinStatusEl.textContent = "âŒ á€›á€œá€’á€ºá€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€•á€½á€¬á€¸á€•á€«á€á€Šá€ºá‹";
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'ğŸ’° á€œá€¾á€Šá€·á€ºá€™á€Šá€º';
                }
            }, 3500); 
        }
        
        function displayIndividualResult(member) {
            resultColorDisplayEl.textContent = member.resultColor;
            const prize = gameData.prizes.find(p => p.colorName === member.resultColor);
            const colorHex = prize?.hex || '#ccc';

            resultColorDisplayEl.style.backgroundColor = colorHex;
            individualResultEl.classList.remove('hidden');
            downloadResultBtn.classList.remove('hidden'); 
            downloadResultBtn.onclick = () => downloadResultAsPNG(member.name, member.resultColor, colorHex);
        }

        // --- PNG Download Logic ---
        function downloadResultAsPNG(memberName, resultColor, colorHex) {
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 250;
            const ctx = canvas.getContext('2d');
            
            const padaukFont = 'Padauk, sans-serif';
            const appTitle = gameData.appTitle || 'á€™á€¯á€”á€·á€ºá€–á€­á€¯á€¸á€á€±á€…á€”á€…á€º';

            // 1. Background (Light Yellow/Gold)
            ctx.fillStyle = '#FFFBEB'; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 2. Border/Accent
            ctx.strokeStyle = THEMES[gameData.theme].borderColor || '#FBBF24'; 
            ctx.lineWidth = 8;
            ctx.strokeRect(4, 4, canvas.width - 8, canvas.height - 8);

            // 3. Text Styling (Title)
            ctx.fillStyle = '#4B5563'; 
            ctx.font = `20px ${padaukFont}`; 
            ctx.textAlign = 'center';
            ctx.fillText(`ğŸ‰ ${appTitle} ğŸ‰`, canvas.width / 2, 40);

            // 4. Congratulations
            ctx.fillStyle = '#1F2937'; 
            ctx.font = `24px ${padaukFont}`; 
            ctx.fillText(`á€‚á€¯á€á€ºá€šá€°á€•á€«á€á€šá€º, ${memberName}`, canvas.width / 2, 85);
            
            // 5. Color Display Box
            ctx.fillStyle = colorHex;
            ctx.fillRect(50, 100, canvas.width - 100, 50);
            
            // Draw contrast text on the color box
            const contrastColor = getContrastColor(rgbToHex(colorHex));
            ctx.fillStyle = contrastColor; 
            ctx.font = `30px ${padaukFont}`; 
            ctx.fillText(resultColor, canvas.width / 2, 137);

            // 6. Wish/Context (Updated)
            ctx.fillStyle = '#6B7280'; 
            ctx.font = `14px ${padaukFont}`; 
            ctx.fillText('á€’á€®á€†á€¯á€•á€™á€¬á€á€œá€±á€¸á€€ á€á€„á€·á€ºá€¡á€á€½á€€á€º á€€á€¶á€€á€±á€¬á€„á€ºá€¸á€á€¼á€„á€ºá€¸á€á€½á€± á€šá€°á€†á€±á€¬á€„á€ºá€œá€¬á€•á€«á€…á€±á‹', canvas.width / 2, 185);
            
            // 7. Footer
            ctx.font = `16px ${padaukFont}`; 
            ctx.fillStyle = '#059669'; 
            ctx.fillText('ğŸ á€á€®á€á€„á€ºá€¸á€€á€»á€½á€á€º á€™á€¯á€”á€·á€ºá€–á€­á€¯á€¸á€á€±á€…á€”á€…á€º ğŸ', canvas.width / 2, 225);

            // 8. Trigger Download
            const dataURL = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = `Thadingyut_Prize_${memberName.replace(/\s/g, '_')}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // --- Admin Panel Functions ---

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                loginSectionEl.classList.add('hidden');
                adminPanelEl.classList.remove('hidden');
                loginErrorEl.classList.add('hidden');
                updateAdminPanelForms();
                renderAdminResultsTable();
                calculateAndDisplayPrizeSum();
            } else {
                loginErrorEl.classList.remove('hidden');
            }
        }
        
        function updateAdminPanelForms() {
            appTitleInputEl.value = gameData.appTitle; // Load app title
            document.getElementById('total-amount').value = gameData.totalAmount;
            document.getElementById('min-amount').value = gameData.minAmount;
            document.getElementById('max-amount').value = gameData.maxAmount;
            
            // Populate Theme Select
            appThemeSelectEl.innerHTML = '';
            Object.keys(THEMES).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = THEMES[key].name;
                if (key === gameData.theme) {
                    option.selected = true;
                }
                appThemeSelectEl.appendChild(option);
            });
            appThemeSelectEl.onchange = handlePrizeInput;

            const membersArray = gameData.teamMembers.map(m => m.name);
            memberCountEl.textContent = membersArray.length; 
            
            document.getElementById('team-members').value = membersArray.join('\n');
            
            renderPrizeSetupForms();
            calculateAndDisplayPrizeSum();
        }

        function calculateRandomPrizes(prizes, T, min, max) {
            T = parseInt(T) || 0;
            min = parseInt(min) || 0;
            max = parseInt(max) || 0;
            const N = prizes.length;
            
            if (N === 0) return [];
            
            const T_min = N * min;
            const T_max = N * max;

            if (T < T_min) T = T_min;
            if (T > T_max) T = T_max;
            if (min > max) max = min;
            
            const prizesCopy = [...prizes];
            let amounts = Array(N).fill(min);
            let remaining = T - T_min;
            
            for (let i = 0; i < N && remaining > 0; i++) {
                const extraCap = max - amounts[i];
                const maxAllocatable = Math.min(remaining, extraCap);
                
                let randomExtra = 0;
                if (maxAllocatable > 0) {
                    randomExtra = Math.floor(Math.random() * (maxAllocatable * 0.5 + 1));
                }
                
                amounts[i] += randomExtra;
                remaining -= randomExtra;
            }

            for (let i = 0; remaining > 0 && i < 100; i++) { 
                for (let j = 0; j < N && remaining > 0; j++) {
                    if (amounts[j] < max) {
                        amounts[j]++;
                        remaining--;
                    }
                }
            }
            
            return prizesCopy.map((prize, index) => ({
                ...prize,
                amount: amounts[index] || min
            }));
        }

        function renderPrizeSetupForms() {
            prizeSetupContainerEl.innerHTML = '';
            
            const prizeCount = gameData.prizes.length;
            prizeCountDisplayEl.textContent = prizeCount;

            gameData.prizes = calculateRandomPrizes(
                gameData.prizes, 
                document.getElementById('total-amount').value, 
                document.getElementById('min-amount').value, 
                document.getElementById('max-amount').value
            );

            gameData.prizes.forEach((prize, index) => {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-5 gap-2 items-center prize-input-row';
                div.setAttribute('data-index', index);
                
                const colorInput = `<input type="color" data-index="${index}" class="col-span-1 w-full h-8 rounded-md" value="${prize.hex}">`;
                const nameInput = `<input type="text" data-index="${index}" data-field="colorName" placeholder="á€¡á€›á€±á€¬á€„á€ºá€¡á€™á€Šá€º" class="col-span-2 p-1 text-sm rounded-md" value="${prize.colorName}">`;
                const amountInput = `<input type="number" data-index="${index}" data-field="amount" placeholder="á€•á€™á€¬á€ MMK" class="col-span-2 p-1 text-sm rounded-md bg-gray-200 text-red-700 font-bold" value="${prize.amount}" readonly>`;

                div.innerHTML = `${colorInput}${nameInput}${amountInput}`;
                prizeSetupContainerEl.appendChild(div);
            });
            
            prizeSetupContainerEl.querySelectorAll('input[type="color"], input[type="text"]').forEach(input => {
                input.addEventListener('input', handlePrizeInput);
            });
        }
        
        function calculateAndDisplayPrizeSum() {
            const prizeSum = gameData.prizes.reduce((sum, p) => sum + parseInt(p.amount), 0);
            const totalBudget = parseInt(document.getElementById('total-amount').value) || gameData.totalAmount;

            prizeSumStatusEl.textContent = `á€†á€¯á€•á€™á€¬á€ á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸: ${prizeSum.toLocaleString()} MMK (á€˜á€á€ºá€‚á€»á€€á€º: ${totalBudget.toLocaleString()} MMK)`;
            prizeSumStatusEl.classList.remove('hidden');

            if (prizeSum === totalBudget) {
                prizeSumStatusEl.classList.remove('text-red-600');
                prizeSumStatusEl.classList.add('text-green-600');
            } else {
                prizeSumStatusEl.classList.remove('text-green-600');
                prizeSumStatusEl.classList.add('text-red-600');
            }
        }
        
        function handlePrizeInput(event) {
            const input = event.target;
            const index = parseInt(input.getAttribute('data-index'));
            const field = input.getAttribute('data-field');

            if (index >= 0 && index < gameData.prizes.length) {
                if (input.type === 'color') {
                    gameData.prizes[index].hex = input.value;
                } else if (field) {
                     gameData.prizes[index][field] = input.value;
                }
            }
            
            const newMembersCount = document.getElementById('team-members').value.split('\n').filter(n => n.trim() !== '').length;
            memberCountEl.textContent = newMembersCount; 
            
            if (newMembersCount !== gameData.prizes.length) {
                 adminMessageEl.textContent = `á€á€á€­! á€¡á€–á€½á€²á€·á€á€„á€ºá€¦á€¸á€›á€± (${newMembersCount}) á€”á€¾á€„á€·á€º á€†á€¯á€¦á€¸á€›á€± (${gameData.prizes.length}) á€™á€á€°á€Šá€®á€•á€«á‹ áá€„á€ºá€¸á€á€­á€¯á€·á€á€Šá€º á€á€°á€Šá€®á€”á€±á€›á€•á€«á€™á€Šá€ºá‹`;
                 adminMessageEl.classList.remove('hidden', 'text-green-600');
                 adminMessageEl.classList.add('text-red-600');
            } else {
                 adminMessageEl.classList.add('hidden');
            }
            
            const changedInputId = event.target.id;
            if (['total-amount', 'min-amount', 'max-amount', 'app-title-input', 'app-theme-select'].includes(changedInputId)) {
                // If core parameters change, re-render and recalculate prizes
                renderPrizeSetupForms(); 
            }
            
            calculateAndDisplayPrizeSum();
        }
        
        function addPrizeField() {
            const membersCount = document.getElementById('team-members').value.split('\n').filter(n => n.trim() !== '').length;

            if (gameData.prizes.length >= membersCount) {
                const newMemberName = `Team Member ${gameData.prizes.length + 1}`;
                document.getElementById('team-members').value += `\n${newMemberName}`;
                memberCountEl.textContent = gameData.prizes.length + 1;
            }
            
            const prizeCount = gameData.prizes.length;
            const newPrize = { colorName: `á€†á€¯á€¡á€á€…á€º ${prizeCount + 1}`, hex: "#CCCCCC", amount: 1000, allocated: false };
            gameData.prizes.push(newPrize);
            
            renderPrizeSetupForms(); 
            calculateAndDisplayPrizeSum();
        }

        function removeLastPrizeField() {
            const membersCount = document.getElementById('team-members').value.split('\n').filter(n => n.trim() !== '').length;

            if (gameData.prizes.length > 1) {
                gameData.prizes.pop();
            } else {
                displayAdminMessage("âŒ á€¡á€”á€Šá€ºá€¸á€†á€¯á€¶á€¸ á€†á€¯ á á€á€¯á€á€±á€¬á€· á€‘á€¬á€¸á€›á€¾á€­á€›á€•á€«á€™á€Šá€ºá‹", 'red');
                return;
            }
            
            if (gameData.prizes.length < membersCount) {
                const membersTextarea = document.getElementById('team-members');
                const lines = membersTextarea.value.split('\n').filter(n => n.trim() !== '');
                lines.pop(); 
                membersTextarea.value = lines.join('\n');
                memberCountEl.textContent = lines.length;
            }

            renderPrizeSetupForms(); 
            calculateAndDisplayPrizeSum();
        }

        async function resetMemberSpin(memberIndex) {
            if (!gameData || memberIndex < 0 || memberIndex >= gameData.teamMembers.length) return;

            const member = gameData.teamMembers[memberIndex];
            if (!member.spun) return; 

            const docRef = firebase.doc(db, GAME_DOC_PATH);
            
            const newPrizes = gameData.prizes.map(p => {
                if (p.colorName === member.resultColor) {
                    return { ...p, allocated: false };
                }
                return p;
            });

            const newMembers = gameData.teamMembers.map((m, i) => {
                if (i === memberIndex) {
                    return { ...m, spun: false, resultColor: null, resultAmount: null, spinnerId: null };
                }
                return m;
            });

            try {
                await firebase.setDoc(docRef, {
                    ...gameData,
                    teamMembers: newMembers,
                    prizes: newPrizes,
                    lastUpdated: new Date().toISOString()
                });
            } catch (e) {
                console.error("Failed to reset member spin:", e);
                displayAdminMessage(`âŒ ${member.name} á á€›á€œá€’á€º á€•á€¼á€”á€ºá€œá€Šá€ºá€á€á€ºá€™á€¾á€á€ºá€›á€”á€º á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á‹`, 'red');
            }
        }

        function renderAdminResultsTable() {
            adminResultsTableEl.innerHTML = '';
            
            const totalAmount = gameData.totalAmount;
            let currentTotal = 0;

            gameData.teamMembers.forEach((member, index) => {
                const tr = document.createElement('tr');
                tr.className = member.spun ? 'bg-green-50/50 border-b border-gray-100' : 'bg-white border-b border-gray-100';
                
                let amountDisplay = member.resultAmount ? member.resultAmount.toLocaleString() : '-';
                let colorDisplay = member.resultColor ? `<span class="font-semibold" style="color: ${gameData.prizes.find(p => p.colorName === member.resultColor)?.hex || '#333'}">${member.resultColor}</span>` : '-';
                let status = member.spun ? 'âœ… á€œá€¾á€Šá€·á€ºá€•á€¼á€®á€¸' : 'â³ á€™á€œá€¾á€Šá€·á€ºá€›á€á€±á€¸';

                if (member.resultAmount) {
                    currentTotal += member.resultAmount;
                }
                
                const resetButton = document.createElement('button');
                resetButton.className = 'text-xs py-1 px-2 rounded font-semibold transition-colors';
                resetButton.setAttribute('data-index', index);
                
                if (member.spun) {
                    resetButton.textContent = 'á€•á€¼á€”á€ºá€•á€¼á€„á€ºá€™á€Šá€º';
                    resetButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-white');
                    resetButton.addEventListener('click', (e) => {
                        const idx = parseInt(e.target.getAttribute('data-index'));
                        if (confirm(`á€á€±á€á€»á€¬á€•á€«á€á€œá€¬á€¸? ${gameData.teamMembers[idx].name} á€›á€²á€· á€›á€œá€’á€ºá€€á€­á€¯ á€•á€¼á€”á€ºá€–á€»á€€á€ºá€•á€¼á€®á€¸ á€†á€¯á€€á€­á€¯ á€•á€¼á€”á€ºá€‘á€Šá€·á€ºá€•á€±á€¸á€•á€«á€™á€Šá€ºá‹`)) {
                            resetMemberSpin(idx);
                        }
                    });
                } else {
                    resetButton.textContent = 'N/A';
                    resetButton.disabled = true;
                    resetButton.classList.add('bg-gray-200', 'text-gray-500');
                }
                
                const resetTd = document.createElement('td');
                resetTd.className = 'p-3 text-center';
                resetTd.appendChild(resetButton);


                tr.innerHTML = `
                    <td class="p-3 font-semibold">${member.name}</td>
                    <td class="p-3 text-center text-sm ${member.spun ? 'text-green-700' : 'text-yellow-700'}">${status}</td>
                    <td class="p-3 text-center text-sm">${colorDisplay}</td>
                    <td class="p-3 text-right font-mono font-bold text-red-700">${amountDisplay}</td>
                `;
                tr.appendChild(resetTd); 
                adminResultsTableEl.appendChild(tr);
            });

            const totalRow = document.createElement('tr');
            totalRow.className = 'bg-green-200 font-bold';
            totalRow.innerHTML = `
                <td class="p-3 text-left">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸:</td>
                <td class="p-3 text-center">${gameData.teamMembers.filter(m => m.spun).length} / ${gameData.teamMembers.length}</td>
                <td class="p-3 text-center"></td>
                <td class="p-3 text-right">${currentTotal.toLocaleString()} / ${totalAmount.toLocaleString()} MMK</td>
                <td class="p-3 text-center"></td>
            `;
            adminResultsTableEl.appendChild(totalRow);
        }

        async function handleAdminSave(event) {
            event.preventDefault();

            const newTitle = appTitleInputEl.value;
            const newTotal = parseInt(document.getElementById('total-amount').value);
            const newMin = parseInt(document.getElementById('min-amount').value);
            const newMax = parseInt(document.getElementById('max-amount').value);
            const newTheme = document.getElementById('app-theme-select').value;
            const newMembersText = document.getElementById('team-members').value;
            const membersArray = newMembersText.split('\n').filter(n => n.trim() !== '');

            const totalMinRequired = membersArray.length * newMin;
            const totalMaxRequired = membersArray.length * newMax;
            
            const prizeCount = gameData.prizes.length;

            if (membersArray.length !== prizeCount) {
                displayAdminMessage(`âŒ á€¡á€–á€½á€²á€·á€á€„á€ºá€¦á€¸á€›á€± (${membersArray.length}) á€”á€¾á€„á€·á€º á€†á€¯á€¦á€¸á€›á€± (${prizeCount}) á€™á€á€°á€Šá€®á€•á€«á‹ áá€„á€ºá€¸á€á€­á€¯á€·á€á€Šá€º á€á€°á€Šá€®á€”á€±á€›á€•á€«á€™á€Šá€ºá‹`, 'red');
                return;
            }

            if (newTotal < totalMinRequired || newTotal > totalMaxRequired) {
                displayAdminMessage(`âŒ á€™á€™á€¾á€”á€ºá€€á€”á€ºá€•á€«á‹ á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸á€„á€½á€±á€•á€™á€¬á€á€á€Šá€º ${membersArray.length} á€šá€±á€¬á€€á€ºá€¡á€á€½á€€á€º ${totalMinRequired.toLocaleString()} MMK á€™á€¾ ${totalMaxRequired.toLocaleString()} MMK á€¡á€á€½á€„á€ºá€¸ á€–á€¼á€…á€ºá€›á€•á€«á€™á€Šá€ºá‹`, 'red');
                return;
            }
            
            const prizeSum = gameData.prizes.reduce((sum, p) => sum + parseInt(p.amount), 0);
            if (prizeSum !== newTotal) {
                 displayAdminMessage(`âŒ á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€›á€”á€º á€¡á€™á€¾á€¬á€¸á‹ á€†á€¯á€•á€™á€¬á€ á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ (${prizeSum.toLocaleString()} MMK) á€á€Šá€º á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸á€„á€½á€± (${newTotal.toLocaleString()} MMK) á€”á€¾á€„á€·á€º á€™á€á€°á€Šá€®á€•á€«á‹`, 'red');
                 return;
            }

            const updatedMembers = membersArray.map(name => {
                return { name: name, spun: false, resultColor: null, resultAmount: null, spinnerId: null };
            });
            
            const newPrizes = gameData.prizes.map(p => ({
                colorName: p.colorName,
                hex: p.hex,
                amount: parseInt(p.amount),
                allocated: false 
            }));


            const newData = {
                appTitle: newTitle,
                totalAmount: newTotal,
                minAmount: newMin,
                maxAmount: newMax,
                theme: newTheme,
                teamMembers: updatedMembers, 
                prizes: newPrizes,
                lastUpdated: new Date().toISOString()
            };

            try {
                const docRef = firebase.doc(db, GAME_DOC_PATH);
                await firebase.setDoc(docRef, newData);
                displayAdminMessage('âœ… á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€•á€¼á€®á€¸áŠ á€‚á€­á€™á€ºá€¸á€¡á€á€¼á€±á€¡á€”á€±á€€á€­á€¯ á€•á€¼á€”á€ºá€œá€Šá€ºá€á€á€ºá€™á€¾á€á€ºá€œá€­á€¯á€€á€ºá€•á€«á€•á€¼á€®á‹', 'green');
            } catch (e) {
                console.error("Firestore Save Error:", e);
                displayAdminMessage('âŒ á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€›á€”á€º á€¡á€™á€¾á€¬á€¸á€›á€¾á€­á€”á€±á€•á€«á€á€Šá€ºá‹', 'red');
            }
        }
        
        function displayAdminMessage(message, type) {
            adminMessageEl.textContent = message;
            adminMessageEl.classList.remove('hidden', 'text-green-600', 'text-red-600');
            adminMessageEl.classList.add(type === 'green' ? 'text-green-600' : 'text-red-600');
            setTimeout(() => {
                adminMessageEl.classList.add('hidden');
            }, 5000);
        }

        function toggleLogin() {
            loginSectionEl.classList.toggle('hidden');
            adminPanelEl.classList.add('hidden'); 
            loginErrorEl.classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function closeAdminPanel() {
            adminPanelEl.classList.add('hidden');
            loginSectionEl.classList.add('hidden');
            adminMessageEl.classList.add('hidden');
            renderGameUI(); 
        }
        
        function getContrastColor(hex) {
            if (!hex || hex.indexOf('#') === -1) return '#000000';
            const r = parseInt(hex.substring(1, 3), 16);
            const g = parseInt(hex.substring(3, 5), 16);
            const b = parseInt(hex.substring(5, 7), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#000000' : '#ffffff';
        }
        
        function rgbToHex(rgb) {
            if (!rgb || rgb.indexOf('rgb') === -1) return '#000000';
            const components = rgb.match(/\d+/g);
            if (!components || components.length < 3) return '#000000';
            const hex = "#" + ((1 << 24) + (parseInt(components[0]) << 16) + (parseInt(components[1]) << 8) + parseInt(components[2])).toString(16).slice(1);
            return hex.toUpperCase();
        }

        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            generateBtn.addEventListener('click', handleSpin);
            loginForm.addEventListener('submit', handleLogin);
            adminForm.addEventListener('submit', handleAdminSave);
            adminLoginBtn.addEventListener('click', toggleLogin);
            closeAdminBtn.addEventListener('click', closeAdminPanel);
            
            addPrizeBtn.addEventListener('click', addPrizeField);
            removePrizeBtn.addEventListener('click', removeLastPrizeField);
            
            document.getElementById('total-amount').addEventListener('input', handlePrizeInput);
            document.getElementById('min-amount').addEventListener('input', handlePrizeInput);
            document.getElementById('max-amount').addEventListener('input', handlePrizeInput);
            appTitleInputEl.addEventListener('input', handlePrizeInput);
            appThemeSelectEl.addEventListener('change', handlePrizeInput);
            
            document.getElementById('team-members').addEventListener('input', (event) => {
                const newMembersCount = event.target.value.split('\n').filter(n => n.trim() !== '').length;
                memberCountEl.textContent = newMembersCount;
                
                if (gameData) {
                    while (gameData.prizes.length < newMembersCount) {
                        const prizeCount = gameData.prizes.length;
                        const newPrize = { colorName: `á€†á€¯á€¡á€á€…á€º ${prizeCount + 1}`, hex: "#CCCCCC", amount: 1000, allocated: false };
                        gameData.prizes.push(newPrize);
                    }
                    while (gameData.prizes.length > newMembersCount) {
                        gameData.prizes.pop();
                    }
                    renderPrizeSetupForms(); 
                }
                
                calculateAndDisplayPrizeSum();
            });
        });

    </script>
</body>
</html>
