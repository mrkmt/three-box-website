<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á€á€®á€á€„á€ºá€¸á€€á€»á€½á€á€ºá€™á€¾á€¬ á€…á€­á€á€ºá€¡á€±á€¸á€á€»á€™á€ºá€¸á€á€¬á€€á€¼á€•á€«á€…á€±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pyidaungsu Font Link -->
    <link href="https://fonts.googleapis.com/css2?family=Padauk:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pyidaungsu+Text:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Firebase & Tone.js SDKs -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.9.15/build/Tone.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = { initializeApp, getAuth, signInAnonymously, getFirestore, doc, getDoc, setDoc, onSnapshot, setLogLevel };
    </script>
    
    <!-- Chosen Palette: Dynamic based on theme (Festive, Modern, Minimal) -->
    <!-- Application Structure Plan: Mobile-first layout restored. Secured Admin Panel for configuration and Global Reset. Instant play (Time Lock removed). Robust initial data check implemented. -->
    <!-- Visualization & Content Choices: Goal: Multi-user sequential spinning with hidden prize amounts, enhanced engagement, and customization. Viz/Presentation Method: Spin Wheel (CSS/JS animation) showing dynamic theme colors. Confetti animation (Canvas/JS) for celebration. Result Modal (HTML/CSS) for focused output. Interaction: Sound effects for spin/result. Admin theme and title selection. PNG download of the result. Justification: Mobile-optimized CSS/Tailwind for better responsive UX. Library/Method: Vanilla JavaScript + Firestore for state/logic, CSS animations for the wheel effect, Tailwind CSS for all styling, Tone.js for audio, Canvas for PNG download and Confetti. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            /* Pyidaungsu is added for better compatibility */
            font-family: 'Pyidaungsu Text', 'Padauk', sans-serif; 
            background-color: #FDFBF6;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(1080deg); } 
        }
        .spinning {
            animation: spin 3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; 
        }
        .wheel-circle {
            transition: transform 3s ease-out;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }
        .wheel-circle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            box-shadow: 0 0 0 10px var(--wheel-border-color, #FBBF24); 
            border-radius: 50%;
        }
        .wheel-segment {
            position: absolute;
            top: 0;
            left: 50%;
            width: 50%;
            height: 50%;
            transform-origin: 0% 100%;
        }
        .wheel-pointer {
            position: absolute;
            top: -15px; 
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            /* Responsive Pointer Size */
            border-left: 8px solid transparent; 
            border-right: 8px solid transparent;
            border-bottom: 16px solid var(--pointer-color, #D946EF); 
            z-index: 20;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 101;
            transform: scale(0.9);
            transition: transform 0.3s ease-out;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 99;
        }
    </style>
</head>

<body class="text-gray-800">

    <div class="container mx-auto px-4 py-8 md:py-12 max-w-4xl">

        <header class="text-center mb-8">
            <h1 id="main-title" class="text-3xl md:text-4xl font-bold text-yellow-900">á€á€®á€á€„á€ºá€¸á€€á€»á€½á€á€ºá€™á€¾á€¬ á€…á€­á€á€ºá€¡á€±á€¸á€á€»á€™á€ºá€¸á€á€¬á€€á€¼á€•á€«á€…á€±
            </h1>
            <p id="main-subtitle" class="text-gray-600 mt-2">á€¡á€–á€½á€²á€·á€â—Œá€„á€ºá€™á€»á€¬á€¸á€¡á€á€½á€€á€º á€•á€»á€±á€¬á€ºá€›á€½á€¾á€„á€ºá€…á€›á€¬ á€†á€¯á€™á€²á€€á€¶á€…á€™á€ºá€¸á€™á€Šá€·á€º á€¡á€…á€®á€¡á€…á€‰á€º</p>
        </header>

        <main
            class="bg-white/60 backdrop-blur-sm p-4 md:p-8 rounded-2xl shadow-lg border border-gray-200 min-h-[500px] relative">

            <!-- Admin Controls Button -->
            <div class="mb-6 text-center">
                <button id="admin-login-btn" class="text-sm text-red-700 hover:text-red-900 font-semibold underline">
                    âš™ï¸ á€…á€®á€™á€¶á€á€”á€·á€ºá€á€½á€²á€™á€¾á€¯ á€á€„á€ºá€›á€±á€¬á€€á€ºá€›á€”á€º
                </button>
            </div>

            <!-- Loading/Error Screen -->
            <div id="loading-screen"
                class="absolute inset-0 bg-white/80 flex flex-col items-center justify-center p-4 z-50">
                <div id="loading-spinner" class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-700 mb-3">
                </div>
                <p id="loading-status" class="text-center text-gray-700 font-semibold">á€…á€”á€…á€ºá€…á€á€„á€ºá€”á€±á€•á€«á€á€Šá€º...</p>
            </div>

            <!-- Login Section -->
            <div id="login-section" class="mb-8 border border-red-300 p-4 rounded-xl bg-red-50 hidden">
                <h2 class="text-lg font-bold text-red-800 border-b pb-2 mb-4">á€…á€®á€™á€¶á€á€”á€·á€ºá€á€½á€²á€á€° á€á€„á€ºá€›á€±á€¬á€€á€ºá€á€¼á€„á€ºá€¸</h2>
                <form id="login-form" class="space-y-3">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700">á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€°á€¡á€™á€Šá€º
                            (kmt)</label>
                        <input type="text" id="username"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">á€œá€»á€¾á€­á€¯á€·á€á€¾á€€á€ºá€”á€¶á€•á€«á€á€º</label>
                        <input type="password" id="password"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                    </div>
                    <button type="submit"
                        class="w-full bg-red-600 text-white font-bold py-2 rounded-lg hover:bg-red-700 transition-colors">ğŸ”
                        á€á€„á€ºá€›á€±á€¬á€€á€ºá€™á€Šá€º</button>
                    <p id="login-error" class="text-red-500 text-sm mt-2 text-center hidden">á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€°á€¡á€™á€Šá€º (á€á€­á€¯á€·)
                        á€œá€»á€¾á€­á€¯á€·á€á€¾á€€á€ºá€”á€¶á€•á€«á€á€º á€™á€™á€¾á€”á€ºá€€á€”á€ºá€•á€«á‹</p>
                </form>
            </div>

            <!-- Admin Panel (Hidden until successful login) -->
            <div id="admin-panel" class="mb-8 relative border border-green-300 p-4 rounded-2xl bg-green-50 hidden">
                <h2 class="text-xl font-bold text-green-800 border-b pb-2 mb-4">âœ… á€…á€®á€™á€¶á€á€”á€·á€ºá€á€½á€²á€á€° Panel</h2>
                <button id="close-admin-btn"
                    class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-xl font-bold p-1">Ã—</button>

                <p class="text-sm text-gray-600 mb-4">á€á€á€­á€•á€±á€¸á€á€»á€€á€º: á€¡á€±á€¬á€€á€ºá€•á€«á€á€”á€ºá€–á€­á€¯á€¸á€™á€»á€¬á€¸á€€á€­á€¯ á€•á€¼á€„á€ºá€†á€„á€ºá€•á€¼á€®á€¸á€•á€«á€€ **á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€›á€”á€º**
                    á€á€œá€¯á€á€ºá€€á€­á€¯ á€”á€¾á€­á€•á€ºá€•á€«á‹</p>

                <form id="admin-form" class="space-y-4">
                    <h3 class="font-semibold text-lg text-green-700">á. á€¡á€á€¼á€±á€á€¶á€á€á€ºá€™á€¾á€á€ºá€á€»á€€á€ºá€™á€»á€¬á€¸</h3>

                    <!-- New Title Input -->
                    <div class="col-span-2">
                        <label for="app-title-input" class="block text-sm font-medium text-gray-700">App
                            á€á€±á€«á€„á€ºá€¸á€…á€¥â—Œá€º/á€¡á€–á€½á€²á€·á€¡á€™á€Šá€º</label>
                        <input type="text" id="app-title-input"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                    </div>

                    <!-- Theme Selector -->
                    <div class="col-span-2">
                        <label for="app-theme-select" class="block text-sm font-medium text-gray-700">App Theme
                            á€›á€½á€±á€¸á€á€»á€šá€ºá€›á€”á€º</label>
                        <select id="app-theme-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
                            required>
                            <!-- Options added by JS -->
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="total-amount" class="block text-sm font-medium text-gray-700">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸á€„á€½á€±á€•á€™á€¬á€
                                (MMK)</label>
                            <input type="number" id="total-amount"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="0" required>
                        </div>
                        <div>
                            <label for="min-amount" class="block text-sm font-medium text-gray-700">á€á€…á€ºá€¦á€¸á€œá€»á€¾á€„á€º á€¡á€”á€Šá€ºá€¸á€†á€¯á€¶á€¸
                                (MMK)</label>
                            <input type="number" id="min-amount"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="0" required>
                        </div>
                        <div class="col-span-1">
                            <label for="max-amount" class="block text-sm font-medium text-gray-700">á€á€…á€ºá€¦á€¸á€œá€»á€¾á€„á€º á€¡á€™á€»á€¬á€¸á€†á€¯á€¶á€¸
                                (MMK)</label>
                            <input type="number" id="max-amount"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" min="0" required>
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700">á€œá€€á€ºá€›á€¾á€­á€¡á€–á€½á€²á€·á€á€„á€ºá€¦á€¸á€›á€±</label>
                            <p id="member-count" class="mt-1 text-2xl font-bold text-green-700 p-2">9</p>
                        </div>
                    </div>
                    <div>
                        <label for="team-members" class="block text-sm font-medium text-gray-700">á€¡á€–á€½á€²á€·á€á€„á€ºá€…á€¬á€›á€„á€ºá€¸
                            (á€á€…á€ºá€€á€¼á€±á€¬á€„á€ºá€¸á€…á€®á€á€½á€²á€›á€±á€¸á€•á€«)</label>
                        <textarea id="team-members" rows="4"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required></textarea>
                    </div>

                    <!-- Dynamic Prize Management Section -->
                    <h3 class="font-semibold text-lg text-green-700 mt-6 flex justify-between items-center">
                        <span>á‚. á€†á€¯á€•á€™á€¬á€ á€á€á€ºá€™á€¾á€á€ºá€á€¼á€„á€ºá€¸ (<span id="prize-count-display">9</span> á€™á€»á€­á€¯á€¸)</span>
                        <div class="space-x-2">
                            <button type="button" id="add-prize-btn"
                                class="text-xs bg-green-500 text-white p-1 rounded hover:bg-green-600 font-semibold">+
                                á€†á€¯á€‘á€Šá€·á€º</button>
                            <button type="button" id="remove-prize-btn"
                                class="text-xs bg-red-500 text-white p-1 rounded hover:bg-red-600 font-semibold">-
                                á€†á€¯á€–á€»á€€á€º</button>
                        </div>
                    </h3>
                    <div id="prize-setup-container" class="space-y-2">
                        <!-- Prize inputs generated by JS -->
                    </div>
                    <p id="prize-sum-status" class="text-sm mt-2 text-center font-semibold text-green-600 hidden"></p>

                    <button type="submit"
                        class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors">ğŸ’¾
                        á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸ á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€›á€”á€º</button>
                    <p id="admin-message" class="text-sm mt-2 text-center font-semibold text-green-600 hidden"></p>
                </form>

                <h3 class="text-xl font-bold text-green-800 mt-8 border-t pt-4">áƒ. á€œá€€á€ºá€›á€¾á€­ á€›á€œá€’á€ºá€™á€»á€¬á€¸ (á€…á€±á€¬á€„á€·á€ºá€€á€¼á€Šá€·á€ºá€›á€”á€º)</h3>
                <p class="text-sm text-gray-600 mb-4">á€œá€¾á€Šá€·á€ºá€•á€¼á€®á€¸á€á€°á€™á€»á€¬á€¸á á€›á€œá€’á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€¤á€”á€±á€›á€¬á€á€½á€„á€º á€€á€¼á€Šá€·á€ºá€›á€¾á€¯á€”á€­á€¯á€„á€ºá€á€Šá€ºá‹</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-green-100 text-sm font-medium text-green-800">
                                <th class="p-3 text-left">á€¡á€–á€½á€²á€·á€á€„á€ºá€¡á€™á€Šá€º</th>
                                <th class="p-3 text-center">á€¡á€á€¼á€±á€¡á€”á€±</th>
                                <th class="p-3 text-center">á€¡á€›á€±á€¬á€„á€º</th>
                                <th class="p-3 text-right">á€„á€½á€±á€•á€™á€¬á€ (MMK)</th>
                            </tr>
                        </thead>
                        <tbody id="admin-results-table">
                            <!-- Real-time results populated by JS -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Global Reset Button -->
                <button id="global-reset-btn"
                    class="w-full mt-4 bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition-colors">
                    ğŸ”„ á€¡á€¬á€¸á€œá€¯á€¶á€¸ á€•á€¼á€”á€ºá€œá€Šá€ºá€…á€á€„á€ºá€™á€Šá€º (Reset All)
                </button>
                
            </div>
            <!-- End Admin/Config Panel -->

            <!-- Public Game View (Wheel & Selection) -->
            <div id="game-view" class="flex flex-col items-center justify-center p-6 md:p-8 hidden">
                <h3 class="text-lg font-bold text-yellow-800 mb-4">ğŸ‰ á€™á€¯á€”á€·á€ºá€–á€­á€¯á€¸á€œá€¾á€Šá€·á€ºá€›á€”á€º ğŸ‰</h3>
                
                <!-- Fixed Date/Time Message (No Countdown) -->
                <div class="w-full max-w-xs mb-6 p-3 rounded-lg text-center bg-yellow-100 border border-yellow-300">
                    <p class="text-sm font-semibold text-yellow-800 mb-1">ááƒáˆá‡ á€á€¯á€”á€¾á€…á€ºáŠ á€á€®á€á€„á€ºá€¸á€€á€»á€½á€á€ºá€œá€•á€¼á€Šá€·á€º á€¡á€˜á€­á€“á€™á€¹á€™á€¬á€”á€±á€·</p>
                    <p class="text-md font-bold text-red-600 mb-2">á€€á€¶á€…á€™á€ºá€¸á€™á€Šá€·á€º á€¡á€…á€®á€¡á€…á€‰á€ºá€œá€±á€¸á€€á€­á€¯ á€Š á‡ á€”á€¬á€›á€®á€™á€¾ á€…á€á€„á€ºá€”á€­á€¯á€„á€ºá€•á€«á€™á€Šá€º</p>
                </div>
                
                <!-- Member Selector -->
                <div class="w-full max-w-xs mb-6">
                    <label for="spinner-select" class="block text-sm font-medium text-gray-700 mb-2">á€á€„á€·á€ºá€¡á€™á€Šá€ºá€€á€­á€¯
                        á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«:</label>
                    <select id="spinner-select"
                        class="block w-full rounded-md border-gray-300 shadow-sm p-2 bg-white text-lg font-semibold">
                        <option value="" disabled selected>--- á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€« ---</option>
                    </select>
                </div>

                <!-- Wheel Area (Responsive Fix: w-56 on mobile, w-64 on desktop) -->
                <div class="relative w-56 h-56 md:w-64 md:h-64 mb-8">
                    <div id="wheel" class="wheel-circle w-full h-full border-4 relative">
                        <!-- Segments will be inserted here by JS -->
                    </div>
                    <div class="wheel-pointer"></div>
                </div>

                <button id="generate-btn"
                    class="w-full max-w-xs font-bold py-4 px-4 rounded-full text-xl transition-all duration-300 shadow-lg hover:shadow-xl focus:outline-none focus:ring-4"
                    disabled>
                    ğŸ’° á€œá€¾á€Šá€·á€ºá€™á€Šá€º
                </button>
                <p id="spin-status" class="mt-4 text-center text-sm text-gray-600 h-6">á€œá€¾á€Šá€·á€ºá€™á€Šá€·á€ºá€á€°á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«á‹</p>

                <!-- Individual Result Modal Trigger is now in the modal itself -->

                <div id="reset-info"
                    class="mt-6 p-4 bg-gray-100 rounded-lg text-sm text-gray-600 hidden w-full max-w-xs text-center">
                    á€‚á€­á€™á€ºá€¸á€¡á€á€…á€ºá€…á€á€„á€ºá€›á€”á€º á€…á€®á€™á€¶á€á€”á€·á€ºá€á€½á€²á€™á€¾á€¯á€™á€¾ á€•á€¼á€”á€ºá€œá€Šá€ºá€…á€á€„á€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€ºá‹
                </div>
            </div>

        </main>

        <footer class="text-center mt-8 text-sm text-gray-500">
            <p>&copy; 2025 | á€•á€»á€±á€¬á€ºá€›á€½á€¾á€„á€ºá€…á€›á€¬á€á€®á€á€„á€ºá€¸á€€á€»á€½á€á€ºá€–á€¼á€…á€ºá€•á€«á€…á€±á‹</p>
        </footer>

    </div>

    <!-- Result Modal -->
    <div id="result-modal-overlay" class="modal-overlay hidden">
        <div id="result-modal-content" class="modal-content p-6 w-11/12 max-w-sm md:max-w-md text-center">
            <h3 class="text-2xl font-bold text-yellow-800 mb-4">ğŸ‰ á€‚á€¯á€á€ºá€šá€°á€•á€«á€á€šá€º ğŸ‰</h3>
            <p id="modal-member-name" class="text-lg font-semibold text-gray-700 mb-3"></p>
            <p class="text-gray-700">á€á€„á€ºá€›á€›á€¾á€­á€á€±á€¬á€†á€¯á€™á€¾á€¬:</p>
            <div id="modal-result-color-display"
                class="font-extrabold text-3xl mt-2 p-3 rounded-lg text-white shadow-xl mx-auto max-w-xs"></div>
            <p id="modal-result-wish" class="text-md text-gray-500 mt-4">á€’á€®á€†á€¯á€•á€™á€¬á€á€œá€±á€¸á€€ á€á€„á€·á€ºá€¡á€á€½á€€á€º á€€á€¶á€€á€±á€¬á€„á€ºá€¸á€á€¼á€„á€ºá€¸á€á€½á€±
                á€šá€°á€†á€±á€¬á€„á€ºá€œá€¬á€•á€«á€…á€±á‹</p>
            <button id="modal-download-btn"
                class="mt-6 bg-emerald-500 text-white py-2 px-4 rounded-lg text-sm font-semibold hover:bg-emerald-600 transition-colors">
                â¬‡ï¸ á€›á€œá€’á€ºá€•á€¯á€¶á€€á€­á€¯ Download á€†á€½á€²á€™á€Šá€º
            </button>
            <button id="modal-close-btn"
                class="mt-4 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg text-sm font-semibold hover:bg-gray-300 transition-colors block w-full">
                á€†á€€á€ºá€œá€€á€ºá€œá€¾á€Šá€·á€ºá€›á€”á€º/á€•á€­á€á€ºá€›á€”á€º
            </button>
        </div>
    </div>

    <!-- Confetti Canvas -->
    <canvas id="confetti-canvas"></canvas>

    <script type="module">
        // --- Hardcoded Authentication Credentials (NEW PASSWORD) ---
        const ADMIN_USERNAME = 'kmt';
        const ADMIN_PASSWORD = 'Thadingyut2026'; 
        
        // --- Firebase Globals & Setup (Using user's provided hardcoded config) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCJ1ZtAu_S0VBZRtyIjuKHfBalHmaeu2aw",
            authDomain: "kmtechspaceship.firebaseapp.com",
            projectId: "kmtechspaceship",
            storageBucket: "kmtechspaceship.firebasestorage.app",
            messagingSenderId: "494150534835",
            appId: "1:494150534835:web:d2b654e04d7b52ca1912c6",
            measurementId: "G-CWJ6BXN5TY"
        };
        
        const appIdForPath = firebaseConfig.projectId; 
        // FIX: New Collection Name for a clean slate
        const GAME_COLLECTION_NAME = 'thadingyut_money_pocket';
        const GAME_DOC_PATH = `artifacts/${appIdForPath}/public/data/${GAME_COLLECTION_NAME}/config`;


        let db, auth;
        let userId = null;
        let gameData = null;


        // --- Theme Definitions ---
        const THEMES = {
            'festive': {
                name: 'ğŸ® á€á€®á€á€„á€ºá€¸á€€á€»á€½á€á€ºá€›á€½á€¾á€„á€ºá€œá€”á€ºá€¸',
                pointerColor: '#D946EF', 
                borderColor: '#FBBF24', 
                buttonClasses: 'bg-red-600 hover:bg-red-700 focus:ring-4 focus:ring-red-300',
            },
            'modern': {
                name: 'âœ¨ á€á€±á€á€ºá€™á€®á€¡á€±á€¸á€†á€±á€¸',
                pointerColor: '#3B82F6', 
                borderColor: '#9CA3AF', 
                buttonClasses: 'bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300',
            },
            'minimal': {
                name: 'âšª á€›á€­á€¯á€¸á€›á€¾á€„á€ºá€¸á€–á€¼á€°á€…á€„á€º',
                pointerColor: '#1F2937', 
                borderColor: '#000000', 
                buttonClasses: 'bg-gray-800 hover:bg-gray-700 focus:ring-4 focus:ring-gray-300',
            }
        };

        // --- Default Data (User's requirements) ---
        const defaultData = {
            appTitle: 'Testing Team', 
            totalAmount: 30000,
            minAmount: 3000,
            maxAmount: 7000,
            theme: 'festive',
            teamMembers: [
                "sis TTM", "sis TWN", "sis NHHM", "sis EMT", "bro YHA",
                "sis LLO", "sis PDL", "sis ZMO", "bro KMT"
            ].join('\n')
        };

        const DEFAULT_PRIZES = [
            { colorName: "á€›á€½á€¾á€±á€›á€±á€¬á€„á€º", hex: "#FFD700", allocated: false },
            { colorName: "á€•á€á€¹á€á€™á€¼á€¬á€¸á€”á€®", hex: "#D81B60", allocated: false },
            { colorName: "á€€á€¼á€±á€¸á€”á€®á€›á€±á€¬á€„á€º", hex: "#CD7F32", allocated: false },
            { colorName: "á€™á€¼á€›á€±á€¬á€„á€º", hex: "#00A86B", allocated: false },
            { colorName: "á€”á€®á€œá€¬á€•á€¼á€¬", hex: "#4169E1", allocated: false },
            { colorName: "á€„á€½á€±á€›á€±á€¬á€„á€º", hex: "#C0C0C0", allocated: false },
            { colorName: "á€œá€­á€™á€¹á€™á€±á€¬á€ºá€›á€±á€¬á€„á€º", hex: "#FF8C00", allocated: false },
            { colorName: "á€›á€½á€€á€ºá€…á€­á€™á€ºá€¸á€›á€±á€¬á€„á€º", hex: "#8FBC8F", allocated: false },
            { colorName: "á€á€›á€™á€ºá€¸á€›á€±á€¬á€„á€º", hex: "#8A2BE2", allocated: false },
        ];


        // --- DOM Elements (Same as last optimized version) ---
        const loadingScreenEl = document.getElementById('loading-screen');
        const loginSectionEl = document.getElementById('login-section');
        const adminPanelEl = document.getElementById('admin-panel');
        const gameViewEl = document.getElementById('game-view');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const closeAdminBtn = document.getElementById('close-admin-btn');
        const loginForm = document.getElementById('login-form');
        const adminForm = document.getElementById('admin-form');
        const loginErrorEl = document.getElementById('login-error');
        const adminMessageEl = document.getElementById('admin-message');
        const memberCountEl = document.getElementById('member-count');
        const prizeCountDisplayEl = document.getElementById('prize-count-display');
        const prizeSetupContainerEl = document.getElementById('prize-setup-container');
        const addPrizeBtn = document.getElementById('add-prize-btn');
        const removePrizeBtn = document.getElementById('remove-prize-btn');
        const prizeSumStatusEl = document.getElementById('prize-sum-status');
        const adminResultsTableEl = document.getElementById('admin-results-table');
        const spinnerSelectEl = document.getElementById('spinner-select');
        const wheelEl = document.getElementById('wheel');
        const generateBtn = document.getElementById('generate-btn');
        const spinStatusEl = document.getElementById('spin-status');
        const globalResetBtn = document.getElementById('global-reset-btn');
        
        const modalOverlayEl = document.getElementById('result-modal-overlay');
        const modalMemberNameEl = document.getElementById('modal-member-name');
        const modalResultColorDisplayEl = document.getElementById('modal-result-color-display');
        const modalDownloadBtn = document.getElementById('modal-download-btn');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        const resetInfoEl = document.getElementById('reset-info');
        const appThemeSelectEl = document.getElementById('app-theme-select');
        const mainTitleEl = document.getElementById('main-title');
        const mainSubtitleEl = document.getElementById('main-subtitle');
        const appTitleInputEl = document.getElementById('app-title-input');
        
        const confettiCanvas = document.getElementById('confetti-canvas');
        const confettiCtx = confettiCanvas.getContext('2d');
        let confettiPieces = [];
        let animationFrameId;


        // --- Tone.js Globals ---
        let spinnerSynth, resultSynth;
        let spinnerLoop;
        let audioContextStarted = false;

        // --- Core Functions ---

        async function initFirebase() {
            try {
                if (firebaseConfig && firebaseConfig.projectId) {
                    const app = firebase.initializeApp(firebaseConfig);
                    db = firebase.getFirestore(app);
                    auth = firebase.getAuth(app);
                    firebase.setLogLevel('error'); 

                    // --- ATTEMPT ANONYMOUS SIGN IN ---
                    try {
                        await firebase.signInAnonymously(auth); 
                        userId = auth.currentUser.uid;
                    } catch (authError) {
                        if (authError.message.includes('auth/requests-from-referer') || 
                            authError.code === 'auth/unauthorized-domain' ||
                            authError.code === 'auth/network-request-failed' 
                        ) {
                            console.warn("âš ï¸ Firebase Auth/Network Error Detected. Proceeding without explicit sign-in.");
                        } else {
                             throw authError; 
                        }
                    }
                    
                    // --- Check and Initialize Default Data ---
                    const docRef = firebase.doc(db, GAME_DOC_PATH);
                    try {
                         const docSnap = await firebase.getDoc(docRef);
                         if (!docSnap.exists()) {
                             console.log("Firestore data not found. Initializing default game data.");
                             await initializeDefaultGame();
                         }
                    } catch(e) {
                         console.warn("Could not check Firestore existence. Relying on listener for data.");
                    }
                    // --- End Check and Initialize Default Data ---
                    
                    setupGameListener();
                    setupTone(); 
                } else {
                    console.error("Firebase configuration is missing or incomplete.");
                }
            } catch (e) {
                console.error("Firebase Initialization Error:", e);
                loadingScreenEl.classList.add('hidden');
                gameViewEl.classList.remove('hidden'); 
                spinStatusEl.textContent = `âŒ á€…á€”á€…á€ºá€á€»á€­á€á€ºá€†á€€á€ºá€™á€¾á€¯ á€¡á€™á€¾á€¬á€¸á‹ (${e.message || 'Error'})`;
            }
        }
        
        function setupTone() {
            if (typeof Tone === 'undefined') return;
            try {
                document.body.addEventListener('click', () => {
                    if (Tone.context.state !== 'running') {
                        Tone.start();
                        audioContextStarted = true;
                    }
                }, { once: true });
                
                spinnerSynth = new Tone.NoiseSynth({
                    noise: { type: "pink" },
                    envelope: { attack: 0.01, decay: 0.05, sustain: 1, release: 0.01 }
                }).toDestination();

                resultSynth = new Tone.Synth({
                    oscillator: { type: "triangle" },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.1, release: 1 }
                }).toDestination();
                
                spinnerLoop = new Tone.Loop(time => {
                    spinnerSynth.triggerAttackRelease("16n", time, 0.3); 
                }, "16n").start(0);
                Tone.Transport.stop(); 
                
            } catch(e) {
                console.warn("Tone.js setup failed:", e);
            }
        }

        function startSpinSound() {
            if (audioContextStarted && typeof Tone !== 'undefined') {
                Tone.Transport.start();
            }
        }

        function stopSpinSound() {
            if (typeof Tone !== 'undefined') {
                Tone.Transport.stop();
            }
        }

        function playResultSound() {
            if (audioContextStarted && typeof Tone !== 'undefined') {
                resultSynth.triggerAttackRelease("C5", "8n");
                resultSynth.triggerAttackRelease("G5", "8n", "+0.1");
            }
        }

        function setupGameListener() {
            const docRef = firebase.doc(db, GAME_DOC_PATH);

            firebase.onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    gameData = docSnap.data();
                    if (gameData.appTitle === undefined) gameData.appTitle = defaultData.appTitle;
                    if (gameData.theme === undefined) gameData.theme = defaultData.theme;
                    
                    renderGameUI();
                } else {
                    // This block is only reached if the document is deleted after initial load.
                    initializeDefaultGame();
                }
            }, (error) => {
                console.error("Firestore Listener Error:", error);
                loadingScreenEl.classList.add('hidden');
                gameViewEl.classList.remove('hidden'); 
                spinStatusEl.textContent = `âŒ Data á€›á€šá€°á€™á€¾á€¯ á€¡á€™á€¾á€¬á€¸á‹ (${error.message || 'Error'})`;
            });
        }
        
        async function initializeDefaultGame() {
            const members = defaultData.teamMembers.split('\n').filter(n => n.trim() !== '');
            const initialMembers = members.map(name => ({
                name: name,
                spun: false,
                resultColor: null,
                resultAmount: null,
                spinnerId: null
            }));

            // Slice only 9 default prizes for 9 members
            const initialPrizes = calculateRandomPrizes(DEFAULT_PRIZES.slice(0, members.length), defaultData.totalAmount, defaultData.minAmount, defaultData.maxAmount);

            const initialData = {
                appTitle: defaultData.appTitle,
                totalAmount: defaultData.totalAmount,
                minAmount: defaultData.minAmount,
                maxAmount: defaultData.maxAmount,
                theme: defaultData.theme,
                teamMembers: initialMembers,
                prizes: initialPrizes,
                lastUpdated: new Date().toISOString()
            };

            try {
                const docRef = firebase.doc(db, GAME_DOC_PATH);
                await firebase.setDoc(docRef, initialData);
            } catch (e) {
                console.error("Failed to initialize default game data:", e);
            }
        }

        function renderGameUI() {
            if (!gameData) return;
            
            updateHeaderAndWish(); 
            applyTheme(gameData.theme); // Apply theme (pointer/border/button color)

            loadingScreenEl.classList.add('hidden');
            gameViewEl.classList.remove('hidden');

            // renderWheel() is called inside applyTheme()
            renderSpinnerSelection(); 

            if (!adminPanelEl.classList.contains('hidden')) {
                updateAdminPanelForms();
                renderAdminResultsTable();
            }
        }
        
        function updateHeaderAndWish() {
            if (!gameData) return; // Guard
            const title = gameData.appTitle || 'á€¡á€–á€½á€²á€·á€¡á€™á€Šá€º';
            // Custom Title/Subtitle
            document.getElementById('main-title').textContent = "á€á€®á€á€„á€ºá€¸á€€á€»á€½á€á€ºá€™á€¾á€¬ á€…á€­á€á€ºá€¡á€±á€¸á€á€»á€™á€ºá€¸á€á€¬á€€á€¼á€•á€«á€…á€±";
            document.getElementById('main-subtitle').textContent = `${title} á€¡á€–á€½á€²á€·á€â—Œá€„á€ºá€™á€»á€¬á€¸á€¡á€á€½á€€á€º á€•á€»á€±á€¬á€ºá€›á€½á€¾á€„á€ºá€…á€›á€¬ á€†á€¯á€™á€²á€€á€¶á€…á€™á€ºá€¸á€™á€Šá€·á€º á€¡á€…á€®á€¡á€…á€‰á€º`;
        }
        
        function applyTheme(themeName) {
            if (!gameData) return; // Guard
            const theme = THEMES[themeName] || THEMES['festive'];
            const root = document.documentElement;
            
            root.style.setProperty('--pointer-color', theme.pointerColor);
            root.style.setProperty('--wheel-border-color', theme.borderColor);
            
            // Re-apply button classes to ensure theme change works instantly
            generateBtn.className = `w-full max-w-xs font-bold py-4 px-4 rounded-full text-xl transition-all duration-300 shadow-lg hover:shadow-xl focus:outline-none ${theme.buttonClasses}`;
            generateBtn.classList.add('text-white'); 
        
            wheelEl.style.borderColor = theme.borderColor;
            renderWheel(); // Call renderWheel here
        }

        function renderWheel() {
            if (!gameData || !gameData.prizes || !Array.isArray(gameData.prizes)) return;
            
            const prizes = gameData.prizes; 
            const numSegments = prizes.length;
            wheelEl.innerHTML = ''; 

            if (numSegments === 0) {
                 wheelEl.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-center text-red-600 font-bold p-4 bg-gray-200/90 rounded-full">á€†á€¯á€¡á€¬á€¸á€œá€¯á€¶á€¸ á€•á€¼á€®á€¸á€†á€¯á€¶á€¸á€á€½á€¬á€¸á€•á€«á€•á€¼á€®á‹</div>';
                 return;
            }

            const anglePerSegment = 360 / numSegments;

            prizes.forEach((prize, index) => {
                const segment = document.createElement('div');
                segment.className = 'wheel-segment';
                segment.style.backgroundColor = prize.hex; // Use hex color
                segment.style.transform = `rotate(${index * anglePerSegment}deg) skewY(-${90 - anglePerSegment}deg)`;
                
                const innerSegment = document.createElement('div');
                innerSegment.className = 'absolute top-0 left-0 w-full h-full';
                innerSegment.style.transform = `skewY(${90 - anglePerSegment}deg) rotate(0deg)`;
                innerSegment.style.paddingLeft = '50%';
                innerSegment.style.textAlign = 'center';
                innerSegment.style.fontSize = '12px';
                innerSegment.style.fontWeight = 'bold';
                innerSegment.style.color = getContrastColor(prize.hex);
                innerSegment.style.lineHeight = '64px';
                
                // Dim the text if the prize is already allocated
                innerSegment.textContent = prize.colorName;
                if (prize.allocated) {
                     innerSegment.style.opacity = 0.5; 
                }

                segment.appendChild(innerSegment);
                wheelEl.appendChild(segment);
            });
        }
        
        function renderSpinnerSelection() {
            if (!gameData || !gameData.teamMembers || !Array.isArray(gameData.teamMembers)) return; 

            const members = gameData.teamMembers;
            spinnerSelectEl.innerHTML = '<option value="" disabled selected>--- á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€« ---</option>';
            generateBtn.disabled = true;
            resetInfoEl.classList.add('hidden');
            
            if (generateBtn.textContent.includes('á€œá€¾á€Šá€·á€ºá€”á€±á€á€Šá€º')) {
                return; 
            }

            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.name;
                option.textContent = member.name;
                if (member.spun) {
                    option.textContent += ' (á€œá€¾á€Šá€·á€ºá€•á€¼á€®á€¸)';
                    option.disabled = true;
                }
                spinnerSelectEl.appendChild(option);
            });
            
            if (members.every(m => m.spun)) {
                 spinStatusEl.textContent = "á€‚á€­á€™á€ºá€¸á€•á€¼á€®á€¸á€†á€¯á€¶á€¸á€•á€«á€•á€¼á€®á‹";
                 resetInfoEl.classList.remove('hidden');
                 generateBtn.disabled = true;
            } else {
                 spinStatusEl.textContent = "á€œá€¾á€Šá€·á€ºá€™á€Šá€·á€ºá€á€°á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«á‹"; 
            }
            
            spinnerSelectEl.onchange = function() {
                const name = spinnerSelectEl.value;
                const selectedMember = members.find(m => m.name === name);

                if (selectedMember && selectedMember.spun) {
                    generateBtn.disabled = true;
                    spinStatusEl.textContent = `âœ… ${selectedMember.name} á€á€Šá€º ${selectedMember.resultColor} á€†á€¯á€€á€­á€¯ á€›á€›á€¾á€­á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹`;
                    // Immediately show modal if already spun
                    displayResultModal(selectedMember.name, selectedMember.resultColor); 
                } else if (selectedMember && !selectedMember.spun) {
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'ğŸ’° á€œá€¾á€Šá€·á€ºá€™á€Šá€º';
                    spinStatusEl.textContent = `${selectedMember.name} á€¡á€á€„á€·á€ºá€–á€¼á€…á€ºá€•á€«á€•á€¼á€®á‹`;
                } else {
                    generateBtn.disabled = true;
                    spinStatusEl.textContent = "á€œá€¾á€Šá€·á€ºá€™á€Šá€·á€ºá€á€°á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«á‹";
                    generateBtn.textContent = 'ğŸ’° á€œá€¾á€Šá€·á€ºá€™á€Šá€º';
                }
            };
            
            // Initial check on load/update
            spinnerSelectEl.dispatchEvent(new Event('change'));
        }

        async function handleSpin() {
            const selectedName = spinnerSelectEl.value;
            if (!selectedName || generateBtn.disabled || !gameData) return;
            
            const currentMemberIndex = gameData.teamMembers.findIndex(m => m.name === selectedName);
            const currentMember = gameData.teamMembers[currentMemberIndex];
            if (!currentMember || currentMember.spun) return;
            
            const availablePrizes = gameData.prizes.filter(p => !p.allocated);
            if (availablePrizes.length === 0) {
                spinStatusEl.textContent = "á€†á€¯á€™á€›á€¾á€­á€á€±á€¬á€·á€•á€«";
                generateBtn.disabled = true;
                return;
            }

            const prizeIndex = Math.floor(Math.random() * availablePrizes.length);
            const selectedPrize = availablePrizes[prizeIndex];
            
            // Wheel logic needs the total number of segments (allocated and unallocated) for rotation calculation
            const totalSegments = gameData.prizes.length;
            const targetPrizeGlobalIndex = gameData.prizes.findIndex(p => p.colorName === selectedPrize.colorName);
            const anglePerSegment = 360 / totalSegments;
            
            const baseRotations = 360 * 10; 
            const targetAngle = targetPrizeGlobalIndex * anglePerSegment + (anglePerSegment / 2);
            
            const offset = Math.random() * (anglePerSegment * 0.8) - (anglePerSegment * 0.4); 
            const finalRotation = baseRotations + targetAngle + offset;
            
            generateBtn.disabled = true;
            generateBtn.textContent = 'ğŸ”„ á€œá€¾á€Šá€·á€ºá€”á€±á€á€Šá€º...';
            spinStatusEl.textContent = "á€†á€¯á€™á€²á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€”á€±á€•á€«á€á€Šá€º...";
            wheelEl.style.transition = 'transform 3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            wheelEl.style.transform = `rotate(${finalRotation}deg)`;
            
            startSpinSound(); 

            setTimeout(async () => {
                stopSpinSound(); 
                playResultSound(); 

                spinStatusEl.textContent = `âœ… ${selectedName} á€¡á€á€½á€€á€º á€›á€œá€’á€ºá€‘á€½á€€á€ºá€•á€±á€«á€ºá€•á€«á€•á€¼á€®á‹`;
                wheelEl.style.transition = 'none'; 
                generateBtn.textContent = 'ğŸ’° á€œá€¾á€Šá€·á€ºá€™á€Šá€º'; 
                
                displayResultModal(selectedName, selectedPrize.colorName);
                startConfetti();

                try {
                    const docRef = firebase.doc(db, GAME_DOC_PATH);
                    
                    const newMembers = gameData.teamMembers.map((m, i) => {
                        if (i === currentMemberIndex) {
                            return { 
                                ...m, 
                                spun: true, 
                                resultColor: selectedPrize.colorName, 
                                resultAmount: selectedPrize.amount,
                                spinnerId: userId
                            };
                        }
                        return m;
                    });
                    
                    const newPrizes = gameData.prizes.map(p => {
                        if (p.colorName === selectedPrize.colorName) {
                            return { ...p, allocated: true };
                        }
                        return p;
                    });

                    await firebase.setDoc(docRef, {
                        ...gameData, 
                        teamMembers: newMembers, 
                        prizes: newPrizes,
                        lastUpdated: new Date().toISOString()
                    });
                } catch (error) {
                    console.error("Firestore Update Error:", error);
                    spinStatusEl.textContent = "âŒ á€›á€œá€’á€ºá€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€•á€½á€¬á€¸á€•á€«á€á€Šá€ºá‹";
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'ğŸ’° á€œá€¾á€Šá€·á€ºá€™á€Šá€º';
                }
            }, 3500); 
        }
        
        function displayResultModal(memberName, resultColor) {
            const prize = gameData.prizes.find(p => p.colorName === resultColor);
            const colorHex = prize?.hex || '#ccc';
            
            modalMemberNameEl.textContent = `á€‚á€¯á€á€ºá€šá€°á€•á€«á€á€šá€º, ${memberName}!`;
            modalResultColorDisplayEl.textContent = resultColor;
            modalResultColorDisplayEl.style.backgroundColor = colorHex;
            
            // Set download button handler
            modalDownloadBtn.onclick = () => downloadResultAsPNG(memberName, resultColor, colorHex);
            
            modalOverlayEl.classList.add('active');
        }
        
        function closeResultModal() {
             modalOverlayEl.classList.remove('active');
             stopConfetti();
             spinnerSelectEl.dispatchEvent(new Event('change'));
        }

        // --- PNG Download Logic ---
        function downloadResultAsPNG(memberName, resultColor, colorHex) {
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 250;
            const ctx = canvas.getContext('2d');
            
            const padaukFont = 'Pyidaungsu Text, Padauk, sans-serif'; // Use Pyidaungsu
            const appTitle = gameData.appTitle || 'á€¡á€–á€½á€²á€·á€¡á€™á€Šá€º';

            ctx.fillStyle = '#FFFBEB'; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.strokeStyle = THEMES[gameData.theme].borderColor || '#FBBF24'; 
            ctx.lineWidth = 8;
            ctx.strokeRect(4, 4, canvas.width - 8, canvas.height - 8);

            ctx.fillStyle = '#4B5563'; 
            ctx.font = `20px ${padaukFont}`; 
            ctx.textAlign = 'center';
            ctx.fillText(`ğŸ‰ ${appTitle} á€™á€¯á€”á€·á€ºá€–á€­á€¯á€¸á€á€±á€…á€”á€…á€º ğŸ‰`, canvas.width / 2, 40); 

            ctx.fillStyle = '#1F2937'; 
            ctx.font = `24px ${padaukFont}`; 
            ctx.fillText(`á€‚á€¯á€á€ºá€šá€°á€•á€«á€á€šá€º, ${memberName}`, canvas.width / 2, 85);
            
            ctx.fillStyle = colorHex;
            ctx.fillRect(50, 100, canvas.width - 100, 50);
            
            const contrastColor = getContrastColor(rgbToHex(colorHex));
            ctx.fillStyle = contrastColor; 
            ctx.font = `30px ${padaukFont}`; 
            ctx.fillText(resultColor, canvas.width / 2, 137);

            ctx.fillStyle = '#6B7280'; 
            ctx.font = `14px ${padaukFont}`; 
            ctx.fillText('á€’á€®á€†á€¯á€•á€™á€¬á€á€œá€±á€¸á€€ á€á€„á€·á€ºá€¡á€á€½á€€á€º á€€á€¶á€€á€±á€¬á€„á€ºá€¸á€á€¼á€„á€ºá€¸á€á€½á€± á€šá€°á€†á€±á€¬á€„á€ºá€œá€¬á€•á€«á€…á€±á‹', canvas.width / 2, 185);
            
            ctx.font = `16px ${padaukFont}`; 
            ctx.fillStyle = '#059669'; 
            ctx.fillText('ğŸ á€á€®á€á€„á€ºá€¸á€€á€»á€½á€á€ºá€œá€€á€ºá€†á€±á€¬á€„á€º ğŸ', canvas.width / 2, 225); 

            const dataURL = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = `Thadingyut_Prize_${memberName.replace(/\s/g, '_')}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // --- Confetti Logic (Canvas) ---
        function resizeCanvas() {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
        }

        class Confetto {
            constructor(x, y, radius, color) {
                this.x = x;
                this.y = y;
                this.radius = radius;
                this.color = color;
                this.velocity = {
                    x: (Math.random() - 0.5) * 5,
                    y: Math.random() * -15
                };
                this.gravity = 0.5;
                this.terminalVelocity = 10;
                this.rotation = 0;
                this.rotationSpeed = Math.random() * 0.1;
                this.opacity = 1;
            }

            update() {
                this.velocity.y += this.gravity;
                if (this.velocity.y > this.terminalVelocity) {
                    this.velocity.y = this.terminalVelocity;
                }
                this.x += this.velocity.x;
                this.y += this.velocity.y;
                this.rotation += this.rotationSpeed;
                this.opacity -= 0.005;
            }

            draw() {
                confettiCtx.save();
                confettiCtx.beginPath();
                confettiCtx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
                confettiCtx.fillStyle = this.color;
                confettiCtx.globalAlpha = this.opacity;
                confettiCtx.fill();
                confettiCtx.restore();
            }
        }
        
        function getConfettiColors() {
             const colors = ['#FFD700', '#D81B60', '#00A86B', '#4169E1', '#FF8C00', '#8A2BE2'];
             return colors[Math.floor(Math.random() * colors.length)];
        }

        function spawnConfetti() {
            const centerX = confettiCanvas.width / 2;
            const centerY = confettiCanvas.height / 2;
            const count = 50;
            
            for (let i = 0; i < count; i++) {
                confettiPieces.push(new Confetto(
                    centerX, 
                    centerY, 
                    Math.random() * 5 + 2, 
                    getConfettiColors()
                ));
            }
        }

        function animateConfetti() {
            confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            
            for (let i = confettiPieces.length - 1; i >= 0; i--) {
                const confetto = confettiPieces[i];
                confetto.update();
                confetto.draw();
                
                if (confetto.opacity <= 0 || confetto.y > confettiCanvas.height) {
                    confettiPieces.splice(i, 1);
                }
            }

            if (confettiPieces.length > 0) {
                animationFrameId = requestAnimationFrame(animateConfetti);
            } else {
                confettiCanvas.style.display = 'none';
            }
        }

        function startConfetti() {
            confettiPieces = [];
            confettiCanvas.style.display = 'block';
            resizeCanvas();
            spawnConfetti();
            
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animateConfetti();
            
            // Stop confetti after a short duration
            setTimeout(stopConfetti, 2500);
        }

        function stopConfetti() {
             if (animationFrameId) cancelAnimationFrame(animationFrameId);
             // Let remaining pieces fall off screen then hide canvas
             if (confettiPieces.length === 0) {
                 confettiCanvas.style.display = 'none';
             } else {
                 // Allow pieces to finish falling
                 setTimeout(() => confettiCanvas.style.display = 'none', 1000);
             }
        }

        // --- Admin Panel Functions ---

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                loginSectionEl.classList.add('hidden');
                adminPanelEl.classList.remove('hidden');
                loginErrorEl.classList.add('hidden');
                updateAdminPanelForms();
                renderAdminResultsTable();
                calculateAndDisplayPrizeSum();
            } else {
                loginErrorEl.textContent = 'á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€°á€¡á€™á€Šá€º (á€á€­á€¯á€·) á€œá€»á€¾á€­á€¯á€·á€á€¾á€€á€ºá€”á€¶á€•á€«á€á€º á€™á€™á€¾á€”á€ºá€€á€”á€ºá€•á€«á‹';
                loginErrorEl.classList.remove('hidden');
            }
        }

        function updateAdminPanelForms() {
            if (!gameData || !gameData.teamMembers || !gameData.prizes) return;

            appTitleInputEl.value = gameData.appTitle; 
            document.getElementById('total-amount').value = gameData.totalAmount;
            document.getElementById('min-amount').value = gameData.minAmount;
            document.getElementById('max-amount').value = gameData.maxAmount;
            
            appThemeSelectEl.innerHTML = '';
            Object.keys(THEMES).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = THEMES[key].name;
                if (key === gameData.theme) {
                    option.selected = true;
                }
                appThemeSelectEl.appendChild(option);
            });
            appThemeSelectEl.onchange = handlePrizeInput;

            const membersArray = gameData.teamMembers.map(m => m.name);
            memberCountEl.textContent = membersArray.length; 
            
            document.getElementById('team-members').value = membersArray.join('\n');
            
            renderPrizeSetupForms();
            calculateAndDisplayPrizeSum();
        }

        function calculateRandomPrizes(prizes, T, min, max) {
            T = parseInt(T) || 0;
            min = parseInt(min) || 0;
            max = parseInt(max) || 0;
            const N = prizes.length;
            
            if (N === 0) return [];
            
            // --- Zero Amount Mode ---
            if (T === 0) {
                 return prizes.map(prize => ({ ...prize, amount: 0 }));
            }
            // --- END Zero Amount Mode ---

            const T_min = N * min;
            const T_max = N * max;

            if (T < T_min) T = T_min;
            if (T > T_max) T = T_max;
            if (min > max) max = min;
            
            const prizesCopy = [...prizes];
            let amounts = Array(N).fill(min);
            let remaining = T - T_min;
            
            for (let i = 0; i < N && remaining > 0; i++) {
                const extraCap = max - amounts[i];
                const maxAllocatable = Math.min(remaining, extraCap);
                
                let randomExtra = 0;
                if (maxAllocatable > 0) {
                    randomExtra = Math.floor(Math.random() * (maxAllocatable * 0.5 + 1));
                }
                
                amounts[i] += randomExtra;
                remaining -= randomExtra;
            }

            for (let i = 0; remaining > 0 && i < 100; i++) { 
                for (let j = 0; j < N && remaining > 0; j++) {
                    if (amounts[j] < max) {
                        amounts[j]++;
                        remaining--;
                    }
                }
            }
            
            // Return updated prizes while preserving all original color/hex properties
            return prizes.map((prize, index) => ({
                colorName: prize.colorName, 
                hex: prize.hex, 
                allocated: prize.allocated, 
                amount: amounts[index] || min 
            }));
        }

        function renderPrizeSetupForms() {
            if (!gameData || !gameData.prizes) return;

            prizeSetupContainerEl.innerHTML = '';
            
            const prizeCount = gameData.prizes.length;
            prizeCountDisplayEl.textContent = prizeCount;

            const currentTotal = parseInt(document.getElementById('total-amount').value);
            const currentMin = parseInt(document.getElementById('min-amount').value);
            const currentMax = parseInt(document.getElementById('max-amount').value);

            // Use current gameData.prizes for names and hexes when recalculating amounts
            const currentPrizesState = gameData.prizes.map(p => ({ 
                colorName: p.colorName, 
                hex: p.hex, 
                allocated: p.allocated 
            }));

            let recalculatedPrizes = calculateRandomPrizes(
                currentPrizesState, 
                currentTotal, 
                currentMin, 
                currentMax
            );
            
            gameData.prizes = recalculatedPrizes;
            const isZeroMode = currentTotal === 0;


            gameData.prizes.forEach((prize, index) => {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-5 gap-2 items-center prize-input-row';
                div.setAttribute('data-index', index);
                
                const colorInput = `<input type="color" data-index="${index}" data-field="hex" class="col-span-1 w-full h-8 rounded-md" value="${prize.hex}">`;
                
                const nameInput = `<input type="text" data-index="${index}" data-field="colorName" placeholder="á€¡á€›á€±á€¬á€„á€ºá€¡á€™á€Šá€º" class="col-span-2 p-1 text-sm rounded-md" value="${prize.colorName}">`;
                
                const amountValue = isZeroMode ? 0 : prize.amount;
                const amountClasses = isZeroMode ? 'bg-gray-300 text-gray-700' : 'bg-gray-200 text-red-700';

                const amountInput = `<input type="number" data-index="${index}" data-field="amount" placeholder="á€•á€™á€¬á€ MMK" class="col-span-2 p-1 text-sm rounded-md ${amountClasses} font-bold" value="${amountValue}" readonly>`;

                div.innerHTML = `${colorInput}${nameInput}${amountInput}`;
                prizeSetupContainerEl.appendChild(div);
            });
            
            // Re-attach listeners for the dynamically created inputs
            prizeSetupContainerEl.querySelectorAll('input[type="color"], input[type="text"]').forEach(input => {
                input.addEventListener('input', handlePrizeInput);
            });
        }
        
        function calculateAndDisplayPrizeSum() {
            if (!gameData) return;

            const totalBudget = parseInt(document.getElementById('total-amount').value) || gameData.totalAmount;
            
            const prizeSum = gameData.prizes.reduce((sum, p) => sum + parseInt(p.amount), 0);
            
            prizeSumStatusEl.textContent = `á€†á€¯á€•á€™á€¬á€ á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸: ${prizeSum.toLocaleString()} MMK (á€˜á€á€ºá€‚á€»á€€á€º: ${totalBudget.toLocaleString()} MMK)`;
            prizeSumStatusEl.classList.remove('hidden');

            if (totalBudget === 0) {
                 prizeSumStatusEl.classList.remove('text-red-600');
                 prizeSumStatusEl.classList.add('text-green-600');
                 return;
            }

            if (prizeSum === totalBudget) {
                prizeSumStatusEl.classList.remove('text-red-600');
                prizeSumStatusEl.classList.add('text-green-600');
            } else {
                prizeSumStatusEl.classList.remove('text-green-600');
                prizeSumStatusEl.classList.add('text-red-600');
            }
        }
        
        function handlePrizeInput(event) {
            if (!gameData) return;
            
            const input = event.target;
            const index = parseInt(input.getAttribute('data-index'));
            const field = input.getAttribute('data-field');
            const changedInputId = event.target.id;
            
            if (index >= 0 && index < gameData.prizes.length) {
                if (field === 'hex') {
                    gameData.prizes[index].hex = input.value;
                } else if (field) {
                     gameData.prizes[index][field] = input.value;
                }
            }
            
            const newMembersCount = document.getElementById('team-members').value.split('\n').filter(n => n.trim() !== '').length;
            memberCountEl.textContent = newMembersCount; 
            
            if (newMembersCount !== gameData.prizes.length) {
                 adminMessageEl.textContent = `á€á€á€­! á€¡á€–á€½á€²á€·á€á€„á€ºá€¦á€¸á€›á€± (${newMembersCount}) á€”á€¾á€„á€·á€º á€†á€¯á€¦á€¸á€›á€± (${gameData.prizes.length}) á€™á€á€°á€Šá€®á€•á€«á‹ áá€„á€ºá€¸á€á€­á€¯á€·á€á€Šá€º á€á€°á€Šá€®á€”á€±á€›á€•á€«á€™á€Šá€ºá‹`;
                 adminMessageEl.classList.remove('hidden', 'text-green-600');
                 adminMessageEl.classList.add('text-red-600');
            } else {
                 adminMessageEl.classList.add('hidden');
            }
            
            
            if (['total-amount', 'min-amount', 'max-amount', 'app-title-input', 'app-theme-select'].includes(changedInputId)) {
                if (changedInputId !== 'app-theme-select') {
                    renderPrizeSetupForms(); 
                }
                
                if (changedInputId === 'app-theme-select') {
                    applyTheme(input.value);
                }
            }
            
            calculateAndDisplayPrizeSum();
        }
        
        function addPrizeField() {
            if (!gameData) return;

            const membersCount = document.getElementById('team-members').value.split('\n').filter(n => n.trim() !== '').length;

            if (gameData.prizes.length >= membersCount) {
                const newMemberName = `Team Member ${gameData.prizes.length + 1}`;
                document.getElementById('team-members').value += `\n${newMemberName}`;
                memberCountEl.textContent = gameData.prizes.length + 1;
            }
            
            const prizeCount = gameData.prizes.length;
            // Preserve existing names when adding new members/prizes
            const newPrize = { colorName: DEFAULT_PRIZES[prizeCount]?.colorName || `á€†á€¯á€¡á€›á€±á€¬á€„á€º ${prizeCount + 1}`, hex: DEFAULT_PRIZES[prizeCount]?.hex || "#CCCCCC", amount: 1000, allocated: false };
            gameData.prizes.push(newPrize);
            
            renderPrizeSetupForms(); 
            calculateAndDisplayPrizeSum();
        }

        function removeLastPrizeField() {
            if (!gameData) return;

            const membersCount = document.getElementById('team-members').value.split('\n').filter(n => n.trim() !== '').length;

            if (gameData.prizes.length > 1) {
                gameData.prizes.pop();
            } else {
                displayAdminMessage("âŒ á€¡á€”á€Šá€ºá€¸á€†á€¯á€¶á€¸ á€†á€¯ á á€á€¯á€á€±á€¬á€· á€‘á€¬á€¸á€›á€¾á€­á€›á€•á€«á€™á€Šá€ºá‹", 'red');
                return;
            }
            
            if (gameData.prizes.length < membersCount) {
                const membersTextarea = document.getElementById('team-members');
                const lines = membersTextarea.value.split('\n').filter(n => n.trim() !== '').length;
                if (lines > 0) {
                    membersTextarea.value = membersTextarea.value.split('\n').slice(0, -1).join('\n');
                    memberCountEl.textContent = lines - 1;
                }
            }

            renderPrizeSetupForms(); 
            calculateAndDisplayPrizeSum();
        }

        async function resetAllGameData() {
            if (!gameData) return;

            if (!confirm("á€á€±á€á€»á€¬á€•á€«á€á€œá€¬á€¸? á€¡á€–á€½á€²á€·á€á€„á€ºá€¡á€¬á€¸á€œá€¯á€¶á€¸á á€›á€œá€’á€ºá€™á€»á€¬á€¸á€”á€¾á€„á€·á€º á€†á€¯á€á€½á€²á€á€±á€™á€¾á€¯á€™á€»á€¬á€¸á€€á€­á€¯ á€¡á€…á€€á€á€Šá€ºá€¸á€€ á€•á€¼á€”á€ºá€œá€Šá€ºá€…á€á€„á€ºá€•á€«á€™á€Šá€ºá‹")) {
                return;
            }
            
            const docRef = firebase.doc(db, GAME_DOC_PATH);

            const initialMembers = gameData.teamMembers.map(m => ({
                name: m.name,
                spun: false,
                resultColor: null,
                resultAmount: gameData.totalAmount === 0 ? 0 : null,
                spinnerId: null
            }));

            // Reset allocated status on all prizes
            const resetPrizes = gameData.prizes.map(p => ({
                ...p,
                allocated: false,
                amount: gameData.totalAmount === 0 ? 0 : p.amount // Keep calculated amount if not zero mode
            }));
            
            try {
                await firebase.setDoc(docRef, {
                    ...gameData,
                    teamMembers: initialMembers,
                    prizes: resetPrizes,
                    lastUpdated: new Date().toISOString()
                });
                displayAdminMessage('âœ… á€‚á€­á€™á€ºá€¸á€¡á€á€¼á€±á€¡á€”á€± á€¡á€¬á€¸á€œá€¯á€¶á€¸á€€á€­á€¯ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€•á€¼á€”á€ºá€œá€Šá€ºá€…á€á€„á€ºá€œá€­á€¯á€€á€ºá€•á€«á€•á€¼á€®á‹', 'green');
            } catch (e) {
                console.error("Failed to reset all game data:", e);
                displayAdminMessage('âŒ á€¡á€¬á€¸á€œá€¯á€¶á€¸ á€•á€¼á€”á€ºá€œá€Šá€ºá€…á€á€„á€ºá€›á€”á€º á€™á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á‹', 'red');
            }
        }


        function renderAdminResultsTable() {
            if (!gameData || !gameData.teamMembers) return;
            
            adminResultsTableEl.innerHTML = '';
            
            const totalAmount = gameData.totalAmount;
            let currentTotal = 0;

            gameData.teamMembers.forEach((member) => {
                const tr = document.createElement('tr');
                tr.className = member.spun ? 'bg-green-50/50 border-b border-gray-100' : 'bg-white border-b border-gray-100';
                
                let amountDisplay = member.resultAmount !== null ? member.resultAmount.toLocaleString() : '-';
                let colorDisplay = member.resultColor ? `<span class="font-semibold" style="color: ${gameData.prizes.find(p => p.colorName === member.resultColor)?.hex || '#333'}">${member.resultColor}</span>` : '-';
                let status = member.spun ? 'âœ… á€œá€¾á€Šá€·á€ºá€•á€¼á€®á€¸' : 'â³ á€™á€œá€¾á€Šá€·á€ºá€›á€á€±á€¸';

                if (member.resultAmount !== null) {
                    currentTotal += member.resultAmount;
                }
                
                tr.innerHTML = `
                    <td class="p-3 font-semibold">${member.name}</td>
                    <td class="p-3 text-center text-sm ${member.spun ? 'text-green-700' : 'text-yellow-700'}">${status}</td>
                    <td class="p-3 text-center text-sm">${colorDisplay}</td>
                    <td class="p-3 text-right font-mono font-bold text-red-700">${amountDisplay}</td>
                `;
                adminResultsTableEl.appendChild(tr);
            });

            const totalRow = document.createElement('tr');
            totalRow.className = 'bg-green-200 font-bold';
            totalRow.innerHTML = `
                <td class="p-3 text-left">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸:</td>
                <td class="p-3 text-center">${gameData.teamMembers.filter(m => m.spun).length} / ${gameData.teamMembers.length}</td>
                <td class="p-3 text-center"></td>
                <td class="p-3 text-right">${currentTotal.toLocaleString()} / ${totalAmount.toLocaleString()} MMK</td>
            `;
            adminResultsTableEl.appendChild(totalRow);
        }

        async function handleAdminSave(event) {
            event.preventDefault();
            if (!gameData) return;

            const newTitle = appTitleInputEl.value;
            const newTotal = parseInt(document.getElementById('total-amount').value);
            const newMin = parseInt(document.getElementById('min-amount').value);
            const newMax = parseInt(document.getElementById('max-amount').value);
            const newTheme = document.getElementById('app-theme-select').value;
            const newMembersText = document.getElementById('team-members').value;
            const membersArray = newMembersText.split('\n').filter(n => n.trim() !== '');

            const totalMinRequired = membersArray.length * newMin;
            const totalMaxRequired = membersArray.length * newMax;
            
            const prizeCount = gameData.prizes.length;
            
            const isZeroMode = newTotal === 0;
            
            if (membersArray.length !== prizeCount) {
                displayAdminMessage(`âŒ á€¡á€–á€½á€²á€·á€á€„á€ºá€¦á€¸á€›á€± (${membersArray.length}) á€”á€¾á€„á€·á€º á€†á€¯á€¦á€¸á€›á€± (${prizeCount}) á€™á€á€°á€Šá€®á€•á€«á‹ áá€„á€ºá€¸á€á€­á€¯á€·á€á€Šá€º á€á€°á€Šá€®á€”á€±á€›á€•á€«á€™á€Šá€ºá‹`, 'red');
                return;
            }

            if (!isZeroMode && (newTotal < totalMinRequired || newTotal > totalMaxRequired)) {
                displayAdminMessage(`âŒ á€™á€™á€¾á€”á€ºá€€á€”á€ºá€•á€«á‹ á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸á€„á€½á€±á€•á€™á€¬á€á€á€Šá€º ${membersArray.length} á€šá€±á€¬á€€á€ºá€¡á€á€½á€€á€º ${totalMinRequired.toLocaleString()} MMK á€™á€¾ ${totalMaxRequired.toLocaleString()} MMK á€¡á€á€½á€„á€ºá€¸ á€–á€¼á€…á€ºá€›á€•á€«á€™á€Šá€ºá‹`, 'red');
                return;
            }
            
            const prizeSum = gameData.prizes.reduce((sum, p) => sum + parseInt(p.amount), 0);
            if (!isZeroMode && prizeSum !== newTotal) {
                 displayAdminMessage(`âŒ á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€›á€”á€º á€¡á€™á€¾á€¬á€¸á‹ á€†á€¯á€•á€™á€¬á€ á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸ (${prizeSum.toLocaleString()} MMK) á€á€Šá€º á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸á€„á€½á€± (${newTotal.toLocaleString()} MMK) á€”á€¾á€„á€·á€º á€™á€á€°á€Šá€®á€•á€«á‹`, 'red');
                 return;
            }
            
            // Check if members or total amount changed significantly enough to warrant a reset
            const oldMembers = gameData.teamMembers.map(m => m.name).join('\n');
            const membersChanged = oldMembers !== newMembersText.trim();
            const totalChanged = gameData.totalAmount !== newTotal;
            
            let membersNeedReset = membersChanged || totalChanged;

            const updatedMembers = membersArray.map(name => {
                 const existing = gameData.teamMembers.find(m => m.name === name);
                 
                 if (existing && !membersNeedReset && !isZeroMode && existing.resultAmount !== 0) {
                     return existing; // Keep existing spin status and result if not resetting
                 }
                 
                 return { 
                     name: name, 
                     spun: false, 
                     resultColor: null, 
                     resultAmount: isZeroMode ? 0 : null, 
                     spinnerId: null 
                 };
            });
            
            const newPrizes = gameData.prizes.map(p => ({
                colorName: p.colorName,
                hex: p.hex,
                amount: isZeroMode ? 0 : parseInt(p.amount),
                allocated: membersNeedReset ? false : p.allocated 
            }));


            const newData = {
                appTitle: newTitle,
                totalAmount: newTotal,
                minAmount: newMin,
                maxAmount: newMax,
                theme: newTheme,
                teamMembers: updatedMembers, 
                prizes: newPrizes,
                lastUpdated: new Date().toISOString()
            };

            try {
                const docRef = firebase.doc(db, GAME_DOC_PATH);
                await firebase.setDoc(docRef, newData);
                
                if (membersNeedReset) {
                    displayAdminMessage('âœ… á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€•á€¼á€®á€¸áŠ á€‚á€­á€™á€ºá€¸á€¡á€á€¼á€±á€¡á€”á€±á€€á€­á€¯ á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€™á€¾á€¯á€™á€»á€¬á€¸á€€á€¼á€±á€¬á€„á€·á€º á€•á€¼á€”á€ºá€œá€Šá€ºá€á€á€ºá€™á€¾á€á€ºá€œá€­á€¯á€€á€ºá€•á€«á€•á€¼á€®á‹', 'green');
                } else {
                    displayAdminMessage('âœ… á€¡á€á€»á€€á€ºá€¡á€œá€€á€ºá€™á€»á€¬á€¸ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹', 'green');
                }
                
            } catch (e) {
                console.error("Firestore Save Error:", e);
                displayAdminMessage('âŒ á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€›á€”á€º á€¡á€™á€¾á€¬á€¸á€›á€¾á€­á€”á€±á€•á€«á€á€Šá€ºá‹', 'red');
            }
        }
        
        function displayAdminMessage(message, type) {
            adminMessageEl.textContent = message;
            adminMessageEl.classList.remove('hidden', 'text-green-600', 'text-red-600');
            adminMessageEl.classList.add(type === 'green' ? 'text-green-600' : 'text-red-600');
            setTimeout(() => {
                adminMessageEl.classList.add('hidden');
            }, 5000);
        }

        function toggleLogin() {
            loginSectionEl.classList.toggle('hidden');
            adminPanelEl.classList.add('hidden'); 
            loginErrorEl.classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function closeAdminPanel() {
            adminPanelEl.classList.add('hidden');
            loginSectionEl.classList.add('hidden');
            adminMessageEl.classList.add('hidden');
            renderGameUI(); 
        }
        
        function getContrastColor(hex) {
            if (!hex || hex.indexOf('#') === -1) return '#000000';
            const r = parseInt(hex.substring(1, 3), 16);
            const g = parseInt(hex.substring(3, 5), 16);
            const b = parseInt(hex.substring(5, 7), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#000000' : '#ffffff';
        }
        
        function rgbToHex(rgb) {
            if (!rgb || rgb.indexOf('rgb') === -1) return '#000000';
            const components = rgb.match(/\d+/g);
            if (!components || components.length < 3) return '#000000';
            const hex = "#" + ((1 << 24) + (parseInt(components[0]) << 16) + (parseInt(components[1]) << 8) + parseInt(components[2])).toString(16).slice(1);
            return hex.toUpperCase();
        }

        // --- Event Listeners and Initialization ---
        window.addEventListener('resize', resizeCanvas);
        
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            generateBtn.addEventListener('click', handleSpin);
            loginForm.addEventListener('submit', handleLogin);
            adminForm.addEventListener('submit', handleAdminSave);
            adminLoginBtn.addEventListener('click', toggleLogin);
            closeAdminBtn.addEventListener('click', closeAdminPanel);
            
            modalCloseBtn.addEventListener('click', closeResultModal);
            
            addPrizeBtn.addEventListener('click', addPrizeField);
            removePrizeBtn.addEventListener('click', removeLastPrizeField);
            globalResetBtn.addEventListener('click', resetAllGameData); // Global Reset Listener
            
            // Listeners for auto-recalculate/update
            document.getElementById('total-amount').addEventListener('input', handlePrizeInput);
            document.getElementById('min-amount').addEventListener('input', handlePrizeInput);
            document.getElementById('max-amount').addEventListener('input', handlePrizeInput);
            appTitleInputEl.addEventListener('input', handlePrizeInput);
            appThemeSelectEl.addEventListener('change', handlePrizeInput);
            
            document.getElementById('team-members').addEventListener('input', (event) => {
                const newMembersCount = event.target.value.split('\n').filter(n => n.trim() !== '').length;
                memberCountEl.textContent = newMembersCount;
                
                if (gameData) {
                    // Update prize count based on member count automatically
                    while (gameData.prizes.length < newMembersCount) {
                        const prizeCount = gameData.prizes.length;
                        // Use default prize name/hex if available, otherwise generic
                        const newPrize = { 
                            colorName: DEFAULT_PRIZES[prizeCount]?.colorName || `á€†á€¯á€¡á€›á€±á€¬á€„á€º ${prizeCount + 1}`, 
                            hex: DEFAULT_PRIZES[prizeCount]?.hex || "#CCCCCC", 
                            amount: 1000, 
                            allocated: false 
                        };
                        gameData.prizes.push(newPrize);
                    }
                    while (gameData.prizes.length > newMembersCount) {
                        gameData.prizes.pop();
                    }
                    renderPrizeSetupForms(); 
                }
                
                calculateAndDisplayPrizeSum();
            });
        });

    </script>
</body>
</html>
